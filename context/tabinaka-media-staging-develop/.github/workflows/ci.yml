name: CI

on:
  push:
    branches: [main, develop, feature/*]
  pull_request:
    branches: [main, develop]

jobs:
  lint-type-build:
    name: Lint â†’ å‹ãƒã‚§ãƒƒã‚¯ â†’ ãƒ“ãƒ«ãƒ‰
    runs-on: ubuntu-latest

    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Node.js ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # 3. ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: npm ci

      # 4. ESLint + Prettier ãƒã‚§ãƒƒã‚¯
      - name: Run ESLint
        run: npm run lint

      # 5. TypeScript å‹ãƒã‚§ãƒƒã‚¯
      - name: TypeScript å‹ãƒã‚§ãƒƒã‚¯
        run: npm run type-check

      # 6 Next.js ãƒ“ãƒ«ãƒ‰æ¤œè¨¼
      - name: Next.js Build
        run: npm run build
        env:
          NODE_ENV: production
          CI: "true"
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
          NEXT_PUBLIC_BASE_URL: ${{ secrets.SITE_URL }}
          NEXT_PUBLIC_SITE_URL: ${{ secrets.SITE_URL }}
          ACCOUNT_TOKEN_SECRET: ${{ secrets.ACCOUNT_TOKEN_SECRET || 'dummy-account-secret' }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY || 'dummy-service-role' }}
          GOOGLE_PLACES_API_KEY_SERVER: ${{ secrets.GOOGLE_PLACES_API_KEY_SERVER || 'dummy-places-server' }}
          CORS_ORIGIN: https://gappytravel.com
          ALLOWED_ORIGINS: https://gappytravel.com,https://www.gappytravel.com

      # 7. ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ä¿å­˜ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: .next/
          retention-days: 7

  docker-build-args-check:
    name: ğŸ³ Docker build (build-args required)
    runs-on: ubuntu-latest
    needs: [lint-type-build]
    if: ${{ secrets.SUPABASE_URL != '' && secrets.SUPABASE_ANON_KEY != '' && secrets.SITE_URL != '' && secrets.GOOGLE_MAPS_API_KEY != '' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Docker build with required args
        run: |
          docker build \
            --platform linux/amd64 \
            --file Dockerfile \
            --build-arg CI=true \
            --build-arg NEXT_PUBLIC_SUPABASE_URL="${{ secrets.SUPABASE_URL }}" \
            --build-arg NEXT_PUBLIC_SUPABASE_ANON_KEY="${{ secrets.SUPABASE_ANON_KEY }}" \
            --build-arg NEXT_PUBLIC_GOOGLE_MAPS_API_KEY="${{ secrets.GOOGLE_MAPS_API_KEY }}" \
            --build-arg NEXT_PUBLIC_BASE_URL="${{ secrets.SITE_URL }}" \
            --build-arg NEXT_PUBLIC_SITE_URL="${{ secrets.SITE_URL }}" \
            -t tabinaka-media-ci:latest .
