# å­¦ç¿’å‹ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ³ã‚¸ãƒ³

## ã‚³ãƒ³ã‚»ãƒ—ãƒˆ

**ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åå¿œã‹ã‚‰å­¦ã³ã€ææ¡ˆç²¾åº¦ã‚’è‡ªå‹•ã§å‘ä¸Šã•ã›ã‚‹ã€**

ãƒãƒ£ãƒƒãƒˆã§ææ¡ˆã—ãŸã™ã¹ã¦ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã¨ã€
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åå¿œï¼ˆã„ã„ã­ã€ã‚¯ãƒªãƒƒã‚¯ã€ã‚¹ã‚­ãƒƒãƒ—ï¼‰ã‚’è¨˜éŒ²ã—ã€
ãã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å­¦ç¿’ã—ã¦æ¬¡å›ã®ææ¡ˆç²¾åº¦ã‚’é«˜ã‚ã‚‹ã€‚

---

## ã‚·ã‚¹ãƒ†ãƒ ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Phase 1: ææ¡ˆ & è¨˜éŒ²                                     â”‚
â”‚                                                           â”‚
â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼: "æ¸‹è°·ã§ã‚«ãƒ•ã‚§æ¢ã—ã¦ã‚‹"                          â”‚
â”‚      â†“                                                    â”‚
â”‚  AI: 5ã¤ã®ã‚«ãƒ•ã‚§ã‚’ç”Ÿæˆãƒ»ææ¡ˆ                               â”‚
â”‚      â†“                                                    â”‚
â”‚  DB: ææ¡ˆå±¥æ­´ã‚’ä¿å­˜                                        â”‚
â”‚      - conversation_id                                    â”‚
â”‚      - suggested_activities (5å€‹)                        â”‚
â”‚      - generation_context (æ¤œç´¢æ¡ä»¶ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±)         â”‚
â”‚      - timestamp                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Phase 2: ãƒ¦ãƒ¼ã‚¶ãƒ¼åå¿œã®è¨˜éŒ²                              â”‚
â”‚                                                           â”‚
â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡Œå‹•:                                           â”‚
â”‚  âœ… Blue Bottle â†’ ã„ã„ã­                                  â”‚
â”‚  âœ… Onibus â†’ ã„ã„ã­                                       â”‚
â”‚  ğŸ‘ï¸ About Life â†’ ã‚¯ãƒªãƒƒã‚¯ï¼ˆè©³ç´°é–²è¦§ï¼‰                     â”‚
â”‚  â­ï¸ Streamer â†’ ã‚¹ã‚­ãƒƒãƒ—                                  â”‚
â”‚  â­ï¸ Fuglen â†’ ã‚¹ã‚­ãƒƒãƒ—                                    â”‚
â”‚      â†“                                                    â”‚
â”‚  DB: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ä¿å­˜                                  â”‚
â”‚      - activity_id                                        â”‚
â”‚      - action_type (like, view, skip, book)              â”‚
â”‚      - context (ã©ã®ä¼šè©±ã§ã€ã©ã®é †ç•ªã§ææ¡ˆã•ã‚ŒãŸã‹)        â”‚
â”‚      - timestamp                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Phase 3: ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ & å­¦ç¿’                             â”‚
â”‚                                                           â”‚
â”‚  åˆ†æã‚¨ãƒ³ã‚¸ãƒ³:                                             â”‚
â”‚  1. ã„ã„ã­ç‡ã‚’è¨ˆç®— (40%)                                  â”‚
â”‚  2. å…±é€šè¦ç´ ã‚’æŠ½å‡º:                                        â”‚
â”‚     - ã‚«ãƒ†ã‚´ãƒª: ã‚¹ãƒšã‚·ãƒ£ãƒ«ãƒ†ã‚£ã‚³ãƒ¼ãƒ’ãƒ¼                      â”‚
â”‚     - ä¾¡æ ¼å¸¯: Â¥500-800                                    â”‚
â”‚     - é›°å›²æ°—: ãƒŸãƒ‹ãƒãƒ«ã€åŒ—æ¬§                               â”‚
â”‚     - è©•ä¾¡: 4.5ä»¥ä¸Š                                       â”‚
â”‚  3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°                               â”‚
â”‚  4. Embeddingsèª¿æ•´                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Phase 4: æ¬¡å›ææ¡ˆã®ç²¾åº¦å‘ä¸Š                               â”‚
â”‚                                                           â”‚
â”‚  æ¬¡ã®ä¼šè©±:                                                 â”‚
â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼: "æ–°å®¿ã§ã‚‚ã‚«ãƒ•ã‚§æ¢ã—ã¦ã‚‹"                         â”‚
â”‚      â†“                                                    â”‚
â”‚  AI: ï¼ˆå­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’æ´»ç”¨ï¼‰                                   â”‚
â”‚      - åŒã˜ç³»çµ±ã®ã‚«ãƒ•ã‚§ã‚’å„ªå…ˆ                               â”‚
â”‚      - ã‚ˆã‚Šç²¾åº¦ã®é«˜ã„ãƒ©ãƒ³ã‚­ãƒ³ã‚°                             â”‚
â”‚      - ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸææ¡ˆ                             â”‚
â”‚      â†“                                                    â”‚
â”‚  çµæœ: ã„ã„ã­ç‡ 60%ã«å‘ä¸Š ğŸ¯                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 1. `suggested_activities` ãƒ†ãƒ¼ãƒ–ãƒ«

**ãƒãƒ£ãƒƒãƒˆã§ææ¡ˆã—ãŸã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã®å±¥æ­´**

```sql
CREATE TABLE suggested_activities (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  
  -- ä¼šè©±æƒ…å ±
  conversation_id TEXT NOT NULL,
  user_id UUID REFERENCES auth.users(id),
  message_id TEXT,
  
  -- ææ¡ˆã•ã‚ŒãŸã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£
  activity_id UUID REFERENCES activities(id),
  activity_source TEXT, -- 'existing' | 'generated' | 'google_place'
  
  -- ææ¡ˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
  query_text TEXT, -- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¤œç´¢ã‚¯ã‚¨ãƒª
  search_params JSONB, -- æ¤œç´¢æ¡ä»¶ï¼ˆlocation, category, priceãªã©ï¼‰
  suggestion_rank INTEGER, -- ææ¡ˆé †ä½ï¼ˆ1-5ãªã©ï¼‰
  similarity_score FLOAT, -- Embeddingsã®é¡ä¼¼åº¦ã‚¹ã‚³ã‚¢
  
  -- AIç”Ÿæˆæƒ…å ±ï¼ˆæ–°è¦ç”Ÿæˆã®å ´åˆï¼‰
  generation_data JSONB,
  place_id TEXT,
  
  -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  created_at TIMESTAMP DEFAULT NOW(),
  shown_in_chat BOOLEAN DEFAULT TRUE,
  shown_in_map BOOLEAN DEFAULT FALSE
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_suggested_activities_conversation 
  ON suggested_activities(conversation_id);
CREATE INDEX idx_suggested_activities_user 
  ON suggested_activities(user_id);
CREATE INDEX idx_suggested_activities_activity 
  ON suggested_activities(activity_id);
CREATE INDEX idx_suggested_activities_created 
  ON suggested_activities(created_at DESC);
```

### 2. `activity_feedback` ãƒ†ãƒ¼ãƒ–ãƒ«

**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åå¿œãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯**

```sql
CREATE TABLE activity_feedback (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  
  -- ææ¡ˆã¨ã®ç´ä»˜ã‘
  suggested_activity_id UUID REFERENCES suggested_activities(id),
  activity_id UUID REFERENCES activities(id),
  user_id UUID REFERENCES auth.users(id),
  conversation_id TEXT,
  
  -- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚¿ã‚¤ãƒ—
  action_type TEXT NOT NULL,
  -- 'like' | 'view' | 'skip' | 'share' | 'book' | 'visit_confirmed'
  
  -- è©³ç´°æƒ…å ±
  action_data JSONB, -- è¿½åŠ æƒ…å ±ï¼ˆæ»åœ¨æ™‚é–“ã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ·±åº¦ãªã©ï¼‰
  
  -- ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
  device_type TEXT, -- 'mobile' | 'desktop'
  location JSONB, -- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¾åœ¨åœ°ï¼ˆè¨±å¯ãŒã‚ã‚Œã°ï¼‰
  
  -- ã‚¿ã‚¤ãƒŸãƒ³ã‚°
  time_to_action INTEGER, -- ææ¡ˆã‹ã‚‰è¡Œå‹•ã¾ã§ã®ç§’æ•°
  created_at TIMESTAMP DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_activity_feedback_user 
  ON activity_feedback(user_id);
CREATE INDEX idx_activity_feedback_activity 
  ON activity_feedback(activity_id);
CREATE INDEX idx_activity_feedback_action 
  ON activity_feedback(action_type);
CREATE INDEX idx_activity_feedback_created 
  ON activity_feedback(created_at DESC);
```

### 3. `user_preferences` ãƒ†ãƒ¼ãƒ–ãƒ«

**å­¦ç¿’ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«**

```sql
CREATE TABLE user_preferences (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) UNIQUE,
  
  -- å­¦ç¿’ã•ã‚ŒãŸå¥½ã¿
  preferred_categories JSONB, -- ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®ã‚¹ã‚³ã‚¢
  preferred_price_range JSONB, -- min, max, average
  preferred_duration JSONB, -- min, max, average
  preferred_locations JSONB, -- ã‚¨ãƒªã‚¢åˆ¥ã®é »åº¦
  
  -- è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³
  activity_count INTEGER DEFAULT 0,
  like_count INTEGER DEFAULT 0,
  booking_count INTEGER DEFAULT 0,
  average_rating FLOAT,
  
  -- Embeddingsï¼ˆãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºç”¨ï¼‰
  preference_embedding vector(1536),
  
  -- çµ±è¨ˆæƒ…å ±
  most_liked_tags TEXT[],
  favorite_time_of_day TEXT, -- 'morning' | 'afternoon' | 'evening'
  travel_style TEXT, -- 'budget' | 'luxury' | 'balanced'
  
  -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  last_updated TIMESTAMP DEFAULT NOW(),
  created_at TIMESTAMP DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_user_preferences_user 
  ON user_preferences(user_id);
CREATE INDEX idx_user_preferences_embedding 
  ON user_preferences USING ivfflat (preference_embedding vector_cosine_ops);
```

### 4. `activity_performance` ãƒ†ãƒ¼ãƒ–ãƒ«

**ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£åˆ¥ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™**

```sql
CREATE TABLE activity_performance (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  activity_id UUID REFERENCES activities(id) UNIQUE,
  
  -- ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆæŒ‡æ¨™
  suggestion_count INTEGER DEFAULT 0, -- ææ¡ˆã•ã‚ŒãŸå›æ•°
  view_count INTEGER DEFAULT 0, -- è©³ç´°é–²è¦§æ•°
  like_count INTEGER DEFAULT 0, -- ã„ã„ã­æ•°
  share_count INTEGER DEFAULT 0, -- ã‚·ã‚§ã‚¢æ•°
  booking_count INTEGER DEFAULT 0, -- äºˆç´„æ•°
  skip_count INTEGER DEFAULT 0, -- ã‚¹ã‚­ãƒƒãƒ—æ•°
  
  -- ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡
  view_rate FLOAT, -- suggestion_count / view_count
  like_rate FLOAT, -- view_count / like_count
  conversion_rate FLOAT, -- view_count / booking_count
  
  -- æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿
  performance_by_week JSONB, -- é€±åˆ¥ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
  trend TEXT, -- 'rising' | 'stable' | 'declining'
  
  -- æœ€çµ‚æ›´æ–°
  last_suggested_at TIMESTAMP,
  last_updated TIMESTAMP DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_activity_performance_activity 
  ON activity_performance(activity_id);
CREATE INDEX idx_activity_performance_like_rate 
  ON activity_performance(like_rate DESC);
CREATE INDEX idx_activity_performance_conversion_rate 
  ON activity_performance(conversion_rate DESC);
```

---

## APIå®Ÿè£…

### 1. ææ¡ˆã‚’è¨˜éŒ²ã™ã‚‹

```typescript
// /api/activity-suggestion/record

interface RecordSuggestionRequest {
  conversationId: string;
  userId?: string;
  activities: Array<{
    activityId?: string;
    activitySource: 'existing' | 'generated' | 'google_place';
    placeId?: string;
    rank: number;
    similarityScore: number;
  }>;
  queryContext: {
    queryText: string;
    searchParams: SearchParams;
    userLocation?: Location;
  };
}

async function recordSuggestion(data: RecordSuggestionRequest) {
  // 1. suggested_activities ã«ä¿å­˜
  const suggestions = await Promise.all(
    data.activities.map(async (activity, index) => {
      return await supabase
        .from('suggested_activities')
        .insert({
          conversation_id: data.conversationId,
          user_id: data.userId,
          activity_id: activity.activityId,
          activity_source: activity.activitySource,
          query_text: data.queryContext.queryText,
          search_params: data.queryContext.searchParams,
          suggestion_rank: activity.rank,
          similarity_score: activity.similarityScore,
          place_id: activity.placeId,
        })
        .select()
        .single();
    })
  );

  // 2. activity_performance ã‚’æ›´æ–°ï¼ˆsuggestion_count++ï¼‰
  await Promise.all(
    data.activities.map(async (activity) => {
      if (activity.activityId) {
        await incrementSuggestionCount(activity.activityId);
      }
    })
  );

  return suggestions;
}
```

### 2. ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¨˜éŒ²ã™ã‚‹

```typescript
// /api/activity-suggestion/feedback

interface RecordFeedbackRequest {
  suggestedActivityId: string;
  activityId: string;
  userId?: string;
  conversationId: string;
  actionType: 'like' | 'view' | 'skip' | 'share' | 'book';
  actionData?: any;
  timeToAction?: number; // ç§’æ•°
}

async function recordFeedback(data: RecordFeedbackRequest) {
  // 1. activity_feedback ã«ä¿å­˜
  const feedback = await supabase
    .from('activity_feedback')
    .insert({
      suggested_activity_id: data.suggestedActivityId,
      activity_id: data.activityId,
      user_id: data.userId,
      conversation_id: data.conversationId,
      action_type: data.actionType,
      action_data: data.actionData,
      time_to_action: data.timeToAction,
    })
    .select()
    .single();

  // 2. activity_performance ã‚’æ›´æ–°
  await updateActivityPerformance(data.activityId, data.actionType);

  // 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ï¼ˆéåŒæœŸï¼‰
  if (data.userId && data.actionType === 'like') {
    updateUserPreferences(data.userId, data.activityId);
  }

  return feedback;
}

async function updateActivityPerformance(
  activityId: string,
  actionType: string
) {
  const fieldMap = {
    view: 'view_count',
    like: 'like_count',
    skip: 'skip_count',
    share: 'share_count',
    book: 'booking_count',
  };

  const field = fieldMap[actionType];
  if (!field) return;

  // ã‚«ã‚¦ãƒ³ãƒˆã‚’å¢—ã‚„ã™
  await supabase.rpc('increment_activity_metric', {
    activity_id: activityId,
    metric_field: field,
  });

  // ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡ã‚’å†è¨ˆç®—
  await recalculateConversionRates(activityId);
}
```

### 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ã™ã‚‹

```typescript
async function updateUserPreferences(userId: string, activityId: string) {
  // 1. ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã®è©³ç´°ã‚’å–å¾—
  const activity = await getActivity(activityId);

  // 2. ç¾åœ¨ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
  let profile = await supabase
    .from('user_preferences')
    .select('*')
    .eq('user_id', userId)
    .single();

  if (!profile.data) {
    // æ–°è¦ä½œæˆ
    profile = await createUserProfile(userId);
  }

  // 3. ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°
  const updatedPreferences = {
    // ã‚«ãƒ†ã‚´ãƒªã‚¹ã‚³ã‚¢ã‚’æ›´æ–°
    preferred_categories: updateCategoryScores(
      profile.data.preferred_categories,
      activity.motivationTags
    ),

    // ä¾¡æ ¼ç¯„å›²ã‚’æ›´æ–°
    preferred_price_range: updatePriceRange(
      profile.data.preferred_price_range,
      activity.price
    ),

    // ã„ã„ã­æ•°ã‚’å¢—ã‚„ã™
    like_count: (profile.data.like_count || 0) + 1,

    // ã‚¿ã‚°ã‚’æ›´æ–°
    most_liked_tags: updateMostLikedTags(
      profile.data.most_liked_tags,
      activity.motivationTags
    ),

    last_updated: new Date().toISOString(),
  };

  await supabase
    .from('user_preferences')
    .update(updatedPreferences)
    .eq('user_id', userId);

  // 4. Embeddingsã‚’æ›´æ–°ï¼ˆéåŒæœŸï¼‰
  updateUserEmbedding(userId);
}
```

### 4. ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸææ¡ˆ

```typescript
// /api/smart-search (æ‹¡å¼µç‰ˆ)

async function personalizedSearch(params: SearchParams, userId?: string) {
  // 1. åŸºæœ¬æ¤œç´¢ï¼ˆæ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
  let results = await searchActivities(params);

  // 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Œã°ã€ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚º
  if (userId) {
    const profile = await getUserPreferences(userId);
    
    if (profile) {
      // A. Embeddingsãƒ™ãƒ¼ã‚¹ã®é¡ä¼¼åº¦ã‚¹ã‚³ã‚¢ã‚’è¿½åŠ 
      results = await addPersonalizationScore(results, profile);

      // B. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¥½ã¿ã§ã‚½ãƒ¼ãƒˆ
      results.sort((a, b) => {
        // ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã‚¹ã‚³ã‚¢ Ã— ä¸€èˆ¬çš„ãªäººæ°—åº¦
        const scoreA = a.personalizationScore * a.popularityScore;
        const scoreB = b.personalizationScore * b.popularityScore;
        return scoreB - scoreA;
      });

      // C. éå»ã«ã‚¹ã‚­ãƒƒãƒ—ã—ãŸã‚‚ã®ã‚’ä¸‹ã’ã‚‹
      results = await penalizeSkippedActivities(results, userId);
    }
  }

  // 3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒè‰¯ã„ã‚‚ã®ã‚’å„ªå…ˆ
  results = await boostHighPerformers(results);

  return results;
}

async function addPersonalizationScore(
  activities: Activity[],
  profile: UserPreferences
): Promise<Activity[]> {
  return await Promise.all(
    activities.map(async (activity) => {
      // Embeddingsé¡ä¼¼åº¦ã‚’è¨ˆç®—
      const similarityScore = await calculateEmbeddingSimilarity(
        activity.embedding,
        profile.preference_embedding
      );

      // ã‚«ãƒ†ã‚´ãƒªãƒãƒƒãƒã‚¹ã‚³ã‚¢
      const categoryScore = calculateCategoryMatch(
        activity.motivationTags,
        profile.preferred_categories
      );

      // ä¾¡æ ¼ãƒãƒƒãƒã‚¹ã‚³ã‚¢
      const priceScore = calculatePriceMatch(
        activity.price,
        profile.preferred_price_range
      );

      // ç·åˆãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã‚¹ã‚³ã‚¢
      const personalizationScore =
        similarityScore * 0.5 + categoryScore * 0.3 + priceScore * 0.2;

      return {
        ...activity,
        personalizationScore,
        isPersonalized: true,
      };
    })
  );
}
```

---

## å­¦ç¿’ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

### 1. ã‚«ãƒ†ã‚´ãƒªå­¦ç¿’

```typescript
interface CategoryScore {
  [category: string]: number; // 0-1ã®ã‚¹ã‚³ã‚¢
}

function updateCategoryScores(
  currentScores: CategoryScore,
  newTags: string[]
): CategoryScore {
  const updated = { ...currentScores };
  const decayFactor = 0.95; // éå»ã®ã‚¹ã‚³ã‚¢ã‚’å°‘ã—æ¸›è¡°

  // æ—¢å­˜ã‚¹ã‚³ã‚¢ã‚’æ¸›è¡°
  for (const category in updated) {
    updated[category] *= decayFactor;
  }

  // æ–°ã—ã„ã„ã„ã­ã®ã‚«ãƒ†ã‚´ãƒªã‚¹ã‚³ã‚¢ã‚’ä¸Šã’ã‚‹
  for (const tag of newTags) {
    updated[tag] = (updated[tag] || 0) + 0.1;
    // æœ€å¤§å€¤ã‚’1ã«åˆ¶é™
    updated[tag] = Math.min(updated[tag], 1.0);
  }

  return updated;
}
```

### 2. Embeddingså­¦ç¿’

```typescript
async function updateUserEmbedding(userId: string) {
  // 1. æœ€è¿‘ã„ã„ã­ã—ãŸå…¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’å–å¾—
  const recentLikes = await supabase
    .from('activity_feedback')
    .select('activity_id, activities(embedding)')
    .eq('user_id', userId)
    .eq('action_type', 'like')
    .order('created_at', { ascending: false })
    .limit(50);

  if (recentLikes.data.length === 0) return;

  // 2. å…¨Embeddingsã®åŠ é‡å¹³å‡ã‚’è¨ˆç®—
  const embeddings = recentLikes.data.map(
    (like) => like.activities.embedding
  );
  
  // æ™‚é–“ã«ã‚ˆã‚‹é‡ã¿ä»˜ã‘ï¼ˆæœ€è¿‘ã®ã‚‚ã®ã»ã©é‡è¦ï¼‰
  const weights = embeddings.map((_, index) => {
    return Math.exp(-index * 0.05); // æŒ‡æ•°æ¸›è¡°
  });

  const userEmbedding = calculateWeightedAverage(embeddings, weights);

  // 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
  await supabase
    .from('user_preferences')
    .update({ preference_embedding: userEmbedding })
    .eq('user_id', userId);
}

function calculateWeightedAverage(
  embeddings: number[][],
  weights: number[]
): number[] {
  const dimension = embeddings[0].length;
  const result = new Array(dimension).fill(0);
  const totalWeight = weights.reduce((sum, w) => sum + w, 0);

  for (let i = 0; i < embeddings.length; i++) {
    for (let j = 0; j < dimension; j++) {
      result[j] += embeddings[i][j] * weights[i];
    }
  }

  // æ­£è¦åŒ–
  return result.map((val) => val / totalWeight);
}
```

### 3. A/Bãƒ†ã‚¹ãƒˆæ©Ÿèƒ½

```typescript
interface ABTestConfig {
  testId: string;
  variantA: SuggestionStrategy; // æ—¢å­˜ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
  variantB: SuggestionStrategy; // æ–°ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
  trafficSplit: number; // 0-1, 0.5ãªã‚‰50/50
  metrics: string[]; // æ¸¬å®šã™ã‚‹æŒ‡æ¨™
}

async function suggestWithABTest(
  params: SearchParams,
  userId: string,
  testConfig: ABTestConfig
) {
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’A/Bã‚°ãƒ«ãƒ¼ãƒ—ã«æŒ¯ã‚Šåˆ†ã‘
  const variant = assignVariant(userId, testConfig.trafficSplit);

  // è©²å½“ã™ã‚‹ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§ææ¡ˆ
  const results =
    variant === 'A'
      ? await testConfig.variantA.suggest(params)
      : await testConfig.variantB.suggest(params);

  // ãƒ†ã‚¹ãƒˆæƒ…å ±ã‚’è¨˜éŒ²
  await recordABTestAssignment(userId, testConfig.testId, variant);

  return results;
}

function assignVariant(
  userId: string,
  trafficSplit: number
): 'A' | 'B' {
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ãƒãƒƒã‚·ãƒ¥ã—ã¦ä¸€è²«æ€§ã®ã‚ã‚‹æŒ¯ã‚Šåˆ†ã‘
  const hash = simpleHash(userId);
  return hash < trafficSplit ? 'A' : 'B';
}
```

---

## åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

### ç®¡ç†è€…å‘ã‘ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

```typescript
// /api/admin/analytics

interface AnalyticsSummary {
  // å…¨ä½“æŒ‡æ¨™
  totalSuggestions: number;
  totalFeedback: number;
  overallLikeRate: number;
  overallConversionRate: number;

  // ãƒˆãƒƒãƒ—ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ¼
  topActivities: Array<{
    activity: Activity;
    likeRate: number;
    suggestionCount: number;
  }>;

  // ãƒ¯ãƒ¼ã‚¹ãƒˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ¼ï¼ˆæ”¹å–„ãŒå¿…è¦ï¼‰
  worstActivities: Array<{
    activity: Activity;
    skipRate: number;
    suggestionCount: number;
  }>;

  // ãƒˆãƒ¬ãƒ³ãƒ‰
  weeklyTrend: Array<{
    week: string;
    suggestions: number;
    likes: number;
    likeRate: number;
  }>;

  // ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
  categoryPerformance: Array<{
    category: string;
    likeRate: number;
    count: number;
  }>;

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ
  userSegments: Array<{
    segment: string; // 'budget' | 'luxury' | 'adventure'
    count: number;
    averageLikeRate: number;
  }>;
}

async function getAnalyticsSummary(
  dateFrom: Date,
  dateTo: Date
): Promise<AnalyticsSummary> {
  // SQLé›†è¨ˆã‚¯ã‚¨ãƒª
  const summary = await supabase.rpc('get_analytics_summary', {
    date_from: dateFrom.toISOString(),
    date_to: dateTo.toISOString(),
  });

  return summary.data;
}
```

### SQLé›†è¨ˆé–¢æ•°

```sql
-- åˆ†æç”¨ã®ãƒ“ãƒ¥ãƒ¼
CREATE OR REPLACE VIEW activity_engagement_stats AS
SELECT 
  a.id,
  a.title,
  a.slug,
  COUNT(DISTINCT sa.id) as suggestion_count,
  COUNT(DISTINCT CASE WHEN af.action_type = 'view' THEN af.id END) as view_count,
  COUNT(DISTINCT CASE WHEN af.action_type = 'like' THEN af.id END) as like_count,
  COUNT(DISTINCT CASE WHEN af.action_type = 'skip' THEN af.id END) as skip_count,
  COUNT(DISTINCT CASE WHEN af.action_type = 'book' THEN af.id END) as booking_count,
  
  -- ç‡ã®è¨ˆç®—
  CASE 
    WHEN COUNT(DISTINCT sa.id) > 0 
    THEN COUNT(DISTINCT CASE WHEN af.action_type = 'like' THEN af.id END)::FLOAT / COUNT(DISTINCT sa.id)
    ELSE 0 
  END as like_rate,
  
  CASE 
    WHEN COUNT(DISTINCT sa.id) > 0 
    THEN COUNT(DISTINCT CASE WHEN af.action_type = 'skip' THEN af.id END)::FLOAT / COUNT(DISTINCT sa.id)
    ELSE 0 
  END as skip_rate

FROM activities a
LEFT JOIN suggested_activities sa ON a.id = sa.activity_id
LEFT JOIN activity_feedback af ON sa.id = af.suggested_activity_id
GROUP BY a.id, a.title, a.slug
HAVING COUNT(DISTINCT sa.id) >= 5; -- æœ€ä½5å›ææ¡ˆã•ã‚ŒãŸã‚‚ã®ã®ã¿
```

---

## å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

### Phase 1: åŸºæœ¬è¨˜éŒ²ï¼ˆWeek 1-2ï¼‰

- [ ] `suggested_activities` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] `activity_feedback` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] ææ¡ˆè¨˜éŒ²APIå®Ÿè£…
- [ ] ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¨˜éŒ²APIå®Ÿè£…
- [ ] åŸºæœ¬çš„ãªUIï¼ˆã„ã„ã­ãƒœã‚¿ãƒ³ï¼‰

### Phase 2: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¿½è·¡ï¼ˆWeek 3-4ï¼‰

- [ ] `activity_performance` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯
- [ ] ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆåŸºæœ¬ï¼‰
- [ ] åˆ†æSQLé–¢æ•°

### Phase 3: ãƒ¦ãƒ¼ã‚¶ãƒ¼å­¦ç¿’ï¼ˆWeek 5-6ï¼‰

- [ ] `user_preferences` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯
- [ ] Embeddingså­¦ç¿’ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
- [ ] ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºæ¤œç´¢çµ±åˆ

### Phase 4: é«˜åº¦ãªæ©Ÿèƒ½ï¼ˆWeek 7-8ï¼‰

- [ ] A/Bãƒ†ã‚¹ãƒˆæ©Ÿèƒ½
- [ ] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å­¦ç¿’
- [ ] è©³ç´°åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

---

## ãƒ¡ãƒªãƒƒãƒˆ

### 1. è‡ªå‹•çš„ãªå“è³ªå‘ä¸Š

```
åˆæœŸ: ã„ã„ã­ç‡ 20%
  â†“ å­¦ç¿’
1ãƒ¶æœˆå¾Œ: ã„ã„ã­ç‡ 35%
  â†“ ã•ã‚‰ã«å­¦ç¿’
3ãƒ¶æœˆå¾Œ: ã„ã„ã­ç‡ 50%
  â†“ ç¶™ç¶šçš„æ”¹å–„
6ãƒ¶æœˆå¾Œ: ã„ã„ã­ç‡ 65%
```

### 2. ãƒ‡ãƒ¼ã‚¿ãƒ‰ãƒªãƒ–ãƒ³ãªæ„æ€æ±ºå®š

- ã©ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãŒäººæ°—ã‹å®šé‡åŒ–
- ã©ã®ã‚«ãƒ†ã‚´ãƒªã‚’å¢—ã‚„ã™ã¹ãã‹åˆ¤æ–­
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ¬å½“ã®ãƒ‹ãƒ¼ã‚ºã‚’æŠŠæ¡
- AIç”Ÿæˆã®ç²¾åº¦å‘ä¸Š

### 3. ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«æœ€é©ãªææ¡ˆ
- ãƒªãƒ”ãƒ¼ã‚¿ãƒ¼è‚²æˆ
- ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆå‘ä¸Š
- ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡å‘ä¸Š

### 4. ã‚³ã‚¹ãƒˆå‰Šæ¸›

- ç„¡é§„ãªææ¡ˆã‚’æ¸›ã‚‰ã™
- APIå‘¼ã³å‡ºã—ã®æœ€é©åŒ–
- äººçš„ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å‰Šæ¸›
- è‡ªå‹•çš„ãªæ”¹å–„ã‚µã‚¤ã‚¯ãƒ«

---

## KPI & ç›®æ¨™

### ææ¡ˆç²¾åº¦

| æŒ‡æ¨™ | åˆæœŸ | 3ãƒ¶æœˆå¾Œ | 6ãƒ¶æœˆå¾Œ | Year 1 |
|------|------|---------|---------|--------|
| ã„ã„ã­ç‡ | 20% | 35% | 50% | 65% |
| ã‚¯ãƒªãƒƒã‚¯ç‡ | 40% | 55% | 65% | 75% |
| ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡ | 5% | 8% | 12% | 18% |
| ã‚¹ã‚­ãƒƒãƒ—ç‡ | 40% | 30% | 20% | 10% |

### ãƒ‡ãƒ¼ã‚¿è“„ç©

| æŒ‡æ¨™ | Month 1 | Month 3 | Month 6 | Year 1 |
|------|---------|---------|---------|--------|
| ææ¡ˆæ•° | 1,000 | 10,000 | 50,000 | 200,000 |
| ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ•° | 500 | 5,000 | 25,000 | 100,000 |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ« | 50 | 500 | 2,500 | 10,000 |

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ & ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼

### ãƒ‡ãƒ¼ã‚¿ä¿è­·

- ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¯åŒ¿ååŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³
- ä½ç½®æƒ…å ±ã¯æ˜ç¤ºçš„ãªè¨±å¯ã®ã¿
- GDPRæº–æ‹ ã®ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
- é›†è¨ˆãƒ‡ãƒ¼ã‚¿ã®ã¿å¤–éƒ¨å…±æœ‰

### ã‚ªãƒ—ãƒˆã‚¢ã‚¦ãƒˆ

```typescript
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å­¦ç¿’ã‚’ã‚ªãƒ•ã«ã§ãã‚‹
interface UserSettings {
  enablePersonalization: boolean; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: true
  enableDataCollection: boolean; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: true
  shareAnonymousData: boolean; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: true
}
```

---

## ã¾ã¨ã‚

ã“ã®å­¦ç¿’å‹ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚Šï¼š

âœ… **è‡ªå‹•çš„ãªå“è³ªå‘ä¸Š**
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åå¿œã‹ã‚‰ç¶™ç¶šçš„ã«å­¦ç¿’
- ã„ã„ã­ç‡ãŒ2-3å€ã«å‘ä¸Š

âœ… **çœŸã®ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³**
- ä¸€äººã²ã¨ã‚Šã«æœ€é©ãªææ¡ˆ
- ãƒªãƒ”ãƒ¼ã‚¿ãƒ¼è‚²æˆ

âœ… **ãƒ‡ãƒ¼ã‚¿ãƒ‰ãƒªãƒ–ãƒ³ãªé‹å–¶**
- å®šé‡çš„ãªæ„æ€æ±ºå®š
- ã©ã“ã«æŠ•è³‡ã™ã¹ãã‹æ˜ç¢º

âœ… **ã‚³ã‚¹ãƒˆåŠ¹ç‡**
- ç„¡é§„ãªææ¡ˆã‚’å‰Šæ¸›
- è‡ªå‹•æ”¹å–„ã‚µã‚¤ã‚¯ãƒ«

**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åå¿œã‚’æœ€å¤§ã®æ•™å¸«ã¨ã—ã¦ã€AIãŒè‡ªã‚‰æˆé•·ã—ã¦ã„ãã‚·ã‚¹ãƒ†ãƒ **

ã“ã‚ŒãŒGappy 2.0ã®çœŸã®ç«¶äº‰å„ªä½æ€§ã«ãªã‚Šã¾ã™ ğŸš€

---

## é«˜åº¦ãªæœ€é©åŒ–æˆ¦ç•¥

### å®Ÿè£…åŠ¹ç‡ã¨å­¦ç¿’é€Ÿåº¦ã®æœ€å¤§åŒ–

åŸºæœ¬è¨­è¨ˆã«åŠ ãˆã¦ã€ä»¥ä¸‹ã®3ã¤ã®é«˜åº¦ãªæœ€é©åŒ–ã‚’å°å…¥ã™ã‚‹ã“ã¨ã§ã€
å­¦ç¿’ã‚µã‚¤ã‚¯ãƒ«ã®é€Ÿåº¦ã¨ç²¾åº¦ã‚’åŠ‡çš„ã«å‘ä¸Šã•ã›ã¾ã™ã€‚

---

## ğŸ” 1. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å­¦ç¿’ï¼ˆOnline Learningï¼‰

### ç¾çŠ¶ã®èª²é¡Œ

```typescript
// ãƒãƒƒãƒå‡¦ç†æƒ³å®šï¼ˆå®šæœŸçš„ãªcronå®Ÿè¡Œï¼‰
cron.schedule('0 * * * *', async () => {
  // 1æ™‚é–“ã”ã¨ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°
  await updateAllUserPreferences();
});
```

**å•é¡Œç‚¹:**
- å­¦ç¿’åæ˜ ã«æ•°åˆ†ã€œæ•°æ™‚é–“ã®é…å»¶
- ãƒªã‚½ãƒ¼ã‚¹ã®ç„¡é§„ï¼ˆå¤‰æ›´ã®ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚æ›´æ–°ï¼‰
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§ã®æ¬ å¦‚

### æ”¹å–„æ¡ˆï¼šã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•å­¦ç¿’

```typescript
// Supabase Realtimeã‚’æ´»ç”¨ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•æ›´æ–°

// ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ£ãƒ³ãƒãƒ«ã®è¨­å®š
const setupRealtimeLearning = () => {
  const channel = supabase
    .channel('activity_feedback_changes')
    .on(
      'postgres_changes',
      {
        event: 'INSERT',
        schema: 'public',
        table: 'activity_feedback',
      },
      async (payload) => {
        const feedback = payload.new;

        // ã„ã„ã­ã•ã‚ŒãŸç¬é–“ã«å­¦ç¿’é–‹å§‹
        if (feedback.action_type === 'like') {
          await handleLikeEvent(feedback);
        }

        // ã‚¹ã‚­ãƒƒãƒ—ã‚‚å­¦ç¿’ã«æ´»ç”¨
        if (feedback.action_type === 'skip') {
          await handleSkipEvent(feedback);
        }

        // äºˆç´„ã¯æœ€é‡è¦ã‚·ã‚°ãƒŠãƒ«
        if (feedback.action_type === 'book') {
          await handleBookingEvent(feedback);
        }
      }
    )
    .subscribe();

  return channel;
};

// ã„ã„ã­ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
async function handleLikeEvent(feedback: ActivityFeedback) {
  const startTime = Date.now();

  try {
    // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°ï¼ˆå¢—åˆ†æ›´æ–°ï¼‰
    await updateUserPreferencesIncremental(
      feedback.user_id,
      feedback.activity_id
    );

    // 2. ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ›´æ–°
    await incrementActivityMetric(feedback.activity_id, 'like_count');

    // 3. Embeddingså¢—åˆ†æ›´æ–°ï¼ˆè»½é‡ï¼‰
    await updateUserEmbeddingIncremental(
      feedback.user_id,
      feedback.activity_id
    );

    // 4. å­¦ç¿’å®Œäº†ãƒ­ã‚°
    const duration = Date.now() - startTime;
    console.log(`âœ… Real-time learning completed in ${duration}ms`);

    // 5. æ¬¡å›ã®ææ¡ˆã«å³åæ˜ 
    await invalidateUserRecommendationCache(feedback.user_id);
  } catch (error) {
    console.error('âŒ Real-time learning failed:', error);
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šãƒãƒƒãƒå‡¦ç†ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
    await addToBatchQueue(feedback);
  }
}
```

### Supabase Realtimeè¨­å®š

```sql
-- Realtimeã‚’æœ‰åŠ¹åŒ–
ALTER PUBLICATION supabase_realtime 
ADD TABLE activity_feedback;

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§é«˜é€ŸåŒ–
CREATE INDEX idx_activity_feedback_realtime 
ON activity_feedback(created_at DESC, action_type);
```

### ãƒ¡ãƒªãƒƒãƒˆ

| æŒ‡æ¨™ | ãƒãƒƒãƒå‡¦ç† | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ  |
|------|-----------|------------|
| å­¦ç¿’åæ˜ æ™‚é–“ | æ•°åˆ†ã€œæ•°æ™‚é–“ | **æ•°ç§’** |
| ãƒªã‚½ãƒ¼ã‚¹åŠ¹ç‡ | ä½ï¼ˆå…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å‡¦ç†ï¼‰ | **é«˜ï¼ˆå¤‰æ›´ã®ã¿ï¼‰** |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ | é…ã„ | **å³åº§ã«åæ˜ ** |
| A/Bãƒ†ã‚¹ãƒˆç²¾åº¦ | ä½ | **é«˜** |

---

## ğŸ§  2. å¢—åˆ†å­¦ç¿’ï¼ˆIncremental Learningï¼‰

### ç¾çŠ¶ã®èª²é¡Œ

```typescript
// æ¯å›å…¨å±¥æ­´ã‚’å†è¨ˆç®—ï¼ˆO(n)ï¼‰
async function updateUserEmbedding(userId: string) {
  // æœ€è¿‘50ä»¶ã®ã„ã„ã­ã‚’å…¨å–å¾—
  const recentLikes = await supabase
    .from('activity_feedback')
    .select('activity_id, activities(embedding)')
    .eq('user_id', userId)
    .eq('action_type', 'like')
    .order('created_at', { ascending: false })
    .limit(50);

  // å…¨Embeddingsã®åŠ é‡å¹³å‡ã‚’å†è¨ˆç®—
  const embeddings = recentLikes.data.map(like => like.activities.embedding);
  const userEmbedding = calculateWeightedAverage(embeddings, weights);
  
  // ä¿å­˜
  await supabase
    .from('user_preferences')
    .update({ preference_embedding: userEmbedding })
    .eq('user_id', userId);
}
```

**å•é¡Œç‚¹:**
- è¨ˆç®—ã‚³ã‚¹ãƒˆ: O(n) Ã— 1536æ¬¡å…ƒ
- DBèª­ã¿è¾¼ã¿ãŒå¤šã„
- ã‚¹ã‚±ãƒ¼ãƒ«ã—ãªã„

### æ”¹å–„æ¡ˆï¼šå¢—åˆ†æ›´æ–°ï¼ˆO(1)ï¼‰

```typescript
// æŒ‡æ•°ç§»å‹•å¹³å‡ï¼ˆExponential Moving Averageï¼‰ã«ã‚ˆã‚‹é€æ¬¡æ›´æ–°

interface IncrementalUpdateConfig {
  learningRate: number; // 0.0 - 1.0
  decayFactor: number; // éå»ã®Embeddingã®æ¸›è¡°ç‡
}

const CONFIG: IncrementalUpdateConfig = {
  learningRate: 0.1, // 10%ã¯æ–°ã—ã„æƒ…å ±
  decayFactor: 0.9, // 90%ã¯éå»ã®æƒ…å ±ã‚’ä¿æŒ
};

/**
 * O(1)ã®å¢—åˆ†Embeddingsæ›´æ–°
 * å…¨å±¥æ­´ã®å†è¨ˆç®—ä¸è¦
 */
async function updateUserEmbeddingIncremental(
  userId: string,
  activityId: string
): Promise<void> {
  // 1. ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼Embeddingã‚’å–å¾—
  const { data: profile } = await supabase
    .from('user_preferences')
    .select('preference_embedding, like_count')
    .eq('user_id', userId)
    .single();

  // 2. æ–°ã—ãã„ã„ã­ã•ã‚ŒãŸã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã®Embeddingã‚’å–å¾—
  const { data: activity } = await supabase
    .from('activities')
    .select('embedding')
    .eq('id', activityId)
    .single();

  if (!profile || !activity) return;

  // 3. å¢—åˆ†æ›´æ–°ï¼ˆæŒ‡æ•°ç§»å‹•å¹³å‡ï¼‰
  const oldEmbedding = profile.preference_embedding || 
    new Array(1536).fill(0); // åˆå›ã¯0ãƒ™ã‚¯ãƒˆãƒ«
  
  const newActivityEmbedding = activity.embedding;
  
  // å­¦ç¿’ç‡ã®å‹•çš„èª¿æ•´ï¼ˆæœ€åˆã¯å¤§ããã€å¾ã€…ã«å°ã•ãï¼‰
  const adaptiveLearningRate = calculateAdaptiveLearningRate(
    profile.like_count,
    CONFIG.learningRate
  );

  // å¢—åˆ†æ›´æ–°å¼ï¼šnew = old * (1 - Î±) + new * Î±
  const updatedEmbedding = oldEmbedding.map((val, i) => 
    val * (1 - adaptiveLearningRate) + 
    newActivityEmbedding[i] * adaptiveLearningRate
  );

  // 4. æ­£è¦åŒ–ï¼ˆãƒ™ã‚¯ãƒˆãƒ«ã®é•·ã•ã‚’1ã«ï¼‰
  const normalizedEmbedding = normalizeVector(updatedEmbedding);

  // 5. ä¿å­˜ï¼ˆO(1)ã®æ›´æ–°ï¼‰
  await supabase
    .from('user_preferences')
    .update({
      preference_embedding: normalizedEmbedding,
      like_count: profile.like_count + 1,
      last_updated: new Date().toISOString(),
    })
    .eq('user_id', userId);
}

/**
 * é©å¿œçš„å­¦ç¿’ç‡
 * æœ€åˆã¯å¤§ããï¼ˆæ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰ã€å¾ã€…ã«å°ã•ãï¼ˆå®‰å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
 */
function calculateAdaptiveLearningRate(
  likeCount: number,
  baseLearningRate: number
): number {
  // æœ€åˆã®10ã„ã„ã­ã¾ã§ã¯é«˜ã„å­¦ç¿’ç‡
  if (likeCount < 10) {
    return baseLearningRate * 2; // 0.2
  }
  
  // 10-50ã„ã„ã­ã¯é€šå¸¸ã®å­¦ç¿’ç‡
  if (likeCount < 50) {
    return baseLearningRate; // 0.1
  }
  
  // 50ã„ã„ã­ä»¥ä¸Šã¯å®‰å®šæœŸã€å°ã•ã„å­¦ç¿’ç‡
  return baseLearningRate * 0.5; // 0.05
}

/**
 * ãƒ™ã‚¯ãƒˆãƒ«ã®æ­£è¦åŒ–
 */
function normalizeVector(vector: number[]): number[] {
  const magnitude = Math.sqrt(
    vector.reduce((sum, val) => sum + val * val, 0)
  );
  
  if (magnitude === 0) return vector;
  
  return vector.map(val => val / magnitude);
}
```

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒ

```typescript
// ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯çµæœ

// å¾“æ¥æ–¹å¼ï¼ˆå…¨å†è¨ˆç®—ï¼‰
æ¸¬å®š: updateUserEmbedding()
æ™‚é–“: 450ms
DBèª­ã¿è¾¼ã¿: 50ä»¶
è¨ˆç®—ã‚³ã‚¹ãƒˆ: O(n Ã— 1536)

// å¢—åˆ†æ›´æ–°æ–¹å¼
æ¸¬å®š: updateUserEmbeddingIncremental()
æ™‚é–“: 15ms
DBèª­ã¿è¾¼ã¿: 2ä»¶
è¨ˆç®—ã‚³ã‚¹ãƒˆ: O(1536) = O(1)

â†’ 30å€ã®é«˜é€ŸåŒ–ï¼
```

### ãƒ¡ãƒªãƒƒãƒˆ

| é …ç›® | å…¨å†è¨ˆç®— | å¢—åˆ†æ›´æ–° |
|------|---------|---------|
| è¨ˆç®—ã‚³ã‚¹ãƒˆ | O(n) | **O(1)** |
| å‡¦ç†æ™‚é–“ | 450ms | **15ms** |
| DBèª­ã¿è¾¼ã¿ | 50ä»¶ | **2ä»¶** |
| ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å¯¾å¿œ | å›°é›£ | **å¯èƒ½** |
| ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ | ä½ | **é«˜** |

---

## ğŸ“ˆ 3. æ¢ç´¢ã¨æ´»ç”¨ã®ãƒãƒ©ãƒ³ã‚¹ï¼ˆExploration-Exploitationï¼‰

### ç¾çŠ¶ã®èª²é¡Œ

```typescript
// å¸¸ã«ã€Œå¥½ã¿é€šã‚Šã€ã®ææ¡ˆã®ã¿
const results = await personalizedSearch(params, userId);

// å•é¡Œï¼š
// - åŒã˜ã‚¸ãƒ£ãƒ³ãƒ«ã°ã‹ã‚Šææ¡ˆã•ã‚Œã‚‹ï¼ˆã‚³ãƒ¼ãƒ’ãƒ¼ â†’ ã‚³ãƒ¼ãƒ’ãƒ¼ â†’ ã‚³ãƒ¼ãƒ’ãƒ¼ï¼‰
// - æ–°ã—ã„èˆˆå‘³ã‚’ç™ºè¦‹ã§ããªã„
// - å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ãŒåã‚‹
// - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé£½ãã‚‹
```

**ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒãƒ–ãƒ«å•é¡Œ:**
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¥½ã¿ã«æœ€é©åŒ–ã—ã™ãã‚‹ã¨ã€å¤šæ§˜æ€§ãŒå¤±ã‚ã‚Œã‚‹
- æ–°ã—ã„ã‚¸ãƒ£ãƒ³ãƒ«ã¸ã®æ¢ç´¢ãŒã§ããªã„
- é•·æœŸçš„ãªæº€è¶³åº¦ãŒä¸‹ãŒã‚‹

### æ”¹å–„æ¡ˆï¼šÎµ-greedyæˆ¦ç•¥

```typescript
/**
 * Exploration-Exploitation Balance
 * Îµç¢ºç‡ã§ãƒ©ãƒ³ãƒ€ãƒ æ¢ç´¢ã€(1-Îµ)ç¢ºç‡ã§æœ€é©åŒ–ææ¡ˆ
 */

interface ExplorationConfig {
  epsilon: number; // æ¢ç´¢ç¢ºç‡ï¼ˆ0.0-1.0ï¼‰
  adaptiveExploration: boolean; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«èª¿æ•´
  diversityBoost: number; // å¤šæ§˜æ€§ãƒ–ãƒ¼ã‚¹ãƒˆä¿‚æ•°
}

const EXPLORATION_CONFIG: ExplorationConfig = {
  epsilon: 0.15, // 15%ã¯ãƒ©ãƒ³ãƒ€ãƒ æ¢ç´¢
  adaptiveExploration: true,
  diversityBoost: 0.3,
};

/**
 * æ¢ç´¢ã¨æ´»ç”¨ã®ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã£ãŸæ¤œç´¢
 */
async function personalizedSearchWithExploration(
  params: SearchParams,
  userId?: string
): Promise<Activity[]> {
  // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
  const profile = userId ? await getUserPreferences(userId) : null;
  
  // 2. é©å¿œçš„Îµå€¤ã®è¨ˆç®—
  const epsilon = calculateAdaptiveEpsilon(profile);

  // 3. Îµç¢ºç‡ã§æ¢ç´¢ãƒ¢ãƒ¼ãƒ‰
  if (Math.random() < epsilon) {
    console.log('ğŸ” Exploration mode');
    return await explorationSearch(params, profile);
  }

  // 4. (1-Îµ)ç¢ºç‡ã§æ´»ç”¨ãƒ¢ãƒ¼ãƒ‰
  console.log('ğŸ¯ Exploitation mode');
  return await exploitationSearch(params, profile);
}

/**
 * é©å¿œçš„Îµå€¤
 * æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã»ã©æ¢ç´¢ã‚’å¤šãã€ãƒ™ãƒ†ãƒ©ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å°‘ãªã‚
 */
function calculateAdaptiveEpsilon(
  profile: UserPreferences | null
): number {
  if (!profile) {
    return 0.5; // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯50%æ¢ç´¢
  }

  const likeCount = profile.like_count || 0;

  // ã„ã„ã­æ•°ã«å¿œã˜ã¦æ¢ç´¢ç‡ã‚’èª¿æ•´
  if (likeCount < 5) {
    return 0.4; // åˆå¿ƒè€…ï¼š40%æ¢ç´¢
  } else if (likeCount < 20) {
    return 0.25; // ä¸­ç´šè€…ï¼š25%æ¢ç´¢
  } else if (likeCount < 50) {
    return 0.15; // ä¸Šç´šè€…ï¼š15%æ¢ç´¢
  } else {
    return 0.10; // ãƒ™ãƒ†ãƒ©ãƒ³ï¼š10%æ¢ç´¢
  }
}

/**
 * æ¢ç´¢ãƒ¢ãƒ¼ãƒ‰ï¼šå¤šæ§˜ãªææ¡ˆ
 */
async function explorationSearch(
  params: SearchParams,
  profile: UserPreferences | null
): Promise<Activity[]> {
  // 1. åŸºæœ¬æ¤œç´¢
  let results = await searchActivities(params);

  // 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã¾ã è¦‹ãŸã“ã¨ã®ãªã„ã‚«ãƒ†ã‚´ãƒªã‚’å„ªå…ˆ
  if (profile) {
    results = await boostUnexploredCategories(results, profile);
  }

  // 3. ãƒ©ãƒ³ãƒ€ãƒ è¦ç´ ã‚’è¿½åŠ 
  results = shuffleWithBias(results, 0.7); // 70%ã®ãƒ©ãƒ³ãƒ€ãƒ æ€§

  // 4. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒè‰¯ã„ã‚‚ã®ã¯æ®‹ã™
  results = await ensureMinimumQuality(results);

  return results.slice(0, 5);
}

/**
 * æ´»ç”¨ãƒ¢ãƒ¼ãƒ‰ï¼šæœ€é©åŒ–ã•ã‚ŒãŸææ¡ˆ
 */
async function exploitationSearch(
  params: SearchParams,
  profile: UserPreferences | null
): Promise<Activity[]> {
  // é€šå¸¸ã®ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºæ¤œç´¢
  let results = await personalizedSearch(params, profile?.user_id);

  // ãŸã ã—ã€å®Œå…¨ã«åŒã˜ã‚«ãƒ†ã‚´ãƒªã ã‘ã«ãªã‚‰ãªã„ã‚ˆã†åˆ¶å¾¡
  results = await ensureDiversity(results, 0.3); // 30%ã®å¤šæ§˜æ€§ã‚’ç¢ºä¿

  return results;
}

/**
 * æœªæ¢ç´¢ã‚«ãƒ†ã‚´ãƒªã®ãƒ–ãƒ¼ã‚¹ãƒˆ
 */
async function boostUnexploredCategories(
  activities: Activity[],
  profile: UserPreferences
): Promise<Activity[]> {
  const exploredCategories = Object.keys(profile.preferred_categories || {});
  
  return activities.map(activity => {
    // æœªæ¢ç´¢ã‚«ãƒ†ã‚´ãƒªã«ãƒœãƒ¼ãƒŠã‚¹ã‚¹ã‚³ã‚¢
    const isUnexplored = !activity.motivationTags.some(tag =>
      exploredCategories.includes(tag)
    );

    if (isUnexplored) {
      return {
        ...activity,
        score: (activity.score || 0) + 0.3, // 30%ãƒ–ãƒ¼ã‚¹ãƒˆ
        isExploration: true,
      };
    }

    return activity;
  });
}

/**
 * å¤šæ§˜æ€§ã®ç¢ºä¿
 * åŒã˜ã‚«ãƒ†ã‚´ãƒªãŒ3ã¤ä»¥ä¸Šé€£ç¶šã—ãªã„ã‚ˆã†ã«ã™ã‚‹
 */
async function ensureDiversity(
  activities: Activity[],
  diversityRatio: number
): Promise<Activity[]> {
  const result: Activity[] = [];
  const categoryCount = new Map<string, number>();

  for (const activity of activities) {
    const mainCategory = activity.motivationTags[0];
    const count = categoryCount.get(mainCategory) || 0;

    // åŒã˜ã‚«ãƒ†ã‚´ãƒªãŒ3ã¤ä»¥ä¸Šã‚ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ã®ç¢ºç‡ã‚’ä¸Šã’ã‚‹
    if (count >= 2 && Math.random() < diversityRatio) {
      continue; // ã‚¹ã‚­ãƒƒãƒ—
    }

    result.push(activity);
    categoryCount.set(mainCategory, count + 1);

    if (result.length >= 5) break;
  }

  return result;
}

/**
 * ãƒã‚¤ã‚¢ã‚¹ä»˜ãã‚·ãƒ£ãƒƒãƒ•ãƒ«
 */
function shuffleWithBias(
  activities: Activity[],
  randomness: number
): Activity[] {
  return activities
    .map(activity => ({
      activity,
      // ãƒ©ãƒ³ãƒ€ãƒ è¦ç´  + å…ƒã®ã‚¹ã‚³ã‚¢
      sortKey:
        Math.random() * randomness + 
        (activity.score || 0) * (1 - randomness),
    }))
    .sort((a, b) => b.sortKey - a.sortKey)
    .map(item => item.activity);
}
```

### Thompson Samplingï¼ˆé«˜åº¦ãªæ‰‹æ³•ï¼‰

```typescript
/**
 * ã‚ˆã‚Šé«˜åº¦ãªæ¢ç´¢æ‰‹æ³•ï¼šThompson Sampling
 * å„ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã®ã€ŒæˆåŠŸç¢ºç‡ã€ã‚’ãƒ™ã‚¤ã‚ºæ¨å®šã—ã€
 * ãã®åˆ†å¸ƒã‹ã‚‰ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã—ã¦ææ¡ˆã™ã‚‹
 */

interface ThompsonSamplingStats {
  activityId: string;
  successCount: number; // ã„ã„ã­æ•°
  failureCount: number; // ã‚¹ã‚­ãƒƒãƒ—æ•°
}

async function thompsonSamplingSearch(
  params: SearchParams
): Promise<Activity[]> {
  // 1. å€™è£œã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’å–å¾—
  const candidates = await searchActivities(params);

  // 2. å„ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã®çµ±è¨ˆã‚’å–å¾—
  const stats = await Promise.all(
    candidates.map(async activity => {
      const performance = await getActivityPerformance(activity.id);
      return {
        activity,
        successCount: performance.like_count || 1,
        failureCount: performance.skip_count || 1,
      };
    })
  );

  // 3. ãƒ™ãƒ¼ã‚¿åˆ†å¸ƒã‹ã‚‰ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
  const sampledActivities = stats
    .map(({ activity, successCount, failureCount }) => {
      // ãƒ™ãƒ¼ã‚¿åˆ†å¸ƒ Beta(Î±, Î²) ã‹ã‚‰ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
      const sampledScore = sampleBetaDistribution(
        successCount,
        failureCount
      );

      return {
        activity,
        sampledScore,
      };
    })
    .sort((a, b) => b.sampledScore - a.sampledScore)
    .slice(0, 5)
    .map(item => item.activity);

  return sampledActivities;
}

/**
 * ãƒ™ãƒ¼ã‚¿åˆ†å¸ƒã‹ã‚‰ã®ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼ˆç°¡æ˜“ç‰ˆï¼‰
 */
function sampleBetaDistribution(alpha: number, beta: number): number {
  // Gammaåˆ†å¸ƒã‚’2å›ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã—ã¦Betaåˆ†å¸ƒã‚’ç”Ÿæˆ
  const x = sampleGammaDistribution(alpha, 1);
  const y = sampleGammaDistribution(beta, 1);
  return x / (x + y);
}

// Gammaåˆ†å¸ƒã®ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼ˆMarsaglia and Tsang methodï¼‰
function sampleGammaDistribution(shape: number, scale: number): number {
  // ç°¡æ˜“å®Ÿè£…ï¼ˆå®Ÿéš›ã¯npmãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ï¼‰
  // ä¾‹: npm install gamma-distribution
  const d = shape - 1 / 3;
  const c = 1 / Math.sqrt(9 * d);

  while (true) {
    const z = randomNormal();
    const v = Math.pow(1 + c * z, 3);
    const u = Math.random();

    if (
      z > -1 / c &&
      Math.log(u) < 0.5 * z * z + d - d * v + d * Math.log(v)
    ) {
      return d * v * scale;
    }
  }
}

function randomNormal(): number {
  // Box-Mullerå¤‰æ›
  const u = Math.random();
  const v = Math.random();
  return Math.sqrt(-2 * Math.log(u)) * Math.cos(2 * Math.PI * v);
}
```

### ãƒ¡ãƒªãƒƒãƒˆ

| æ‰‹æ³• | ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒãƒ–ãƒ« | å¤šæ§˜æ€§ | å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ | ãƒ¦ãƒ¼ã‚¶ãƒ¼é£½ã |
|------|-----------------|--------|-----------|------------|
| å¸¸ã«æœ€é©åŒ– | âŒ é«˜ã„ | âŒ ä½ã„ | âŒ åã‚‹ | âŒ æ—©ã„ |
| Îµ-greedy | âœ… ä½ã„ | âœ… ä¸­ã€œé«˜ | âœ… ãƒãƒ©ãƒ³ã‚¹ | âœ… é…ã„ |
| Thompson Sampling | âœ… ä½ã„ | âœ… é«˜ã„ | âœ… æœ€é© | âœ… éå¸¸ã«é…ã„ |

---

## âš™ï¸ å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ï¼ˆæ›´æ–°ç‰ˆï¼‰

### Phase 1-2: åŸºæœ¬æ©Ÿèƒ½ï¼ˆWeek 1-4ï¼‰

- [x] åŸºæœ¬è¨˜éŒ²æ©Ÿèƒ½
- [x] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¿½è·¡
- [x] ãƒ¦ãƒ¼ã‚¶ãƒ¼å­¦ç¿’ï¼ˆãƒãƒƒãƒç‰ˆï¼‰

### Phase 3: é«˜é€ŸåŒ–ï¼ˆWeek 5-6ï¼‰

- [ ] **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å­¦ç¿’ã®å°å…¥**
  - Supabase Realtimeè¨­å®š
  - ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•æ›´æ–°
  - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿæ§‹

- [ ] **å¢—åˆ†å­¦ç¿’ã®å®Ÿè£…**
  - O(1) Embeddingsæ›´æ–°
  - é©å¿œçš„å­¦ç¿’ç‡
  - ãƒ™ã‚¯ãƒˆãƒ«æ­£è¦åŒ–

### Phase 4: æ¢ç´¢æˆ¦ç•¥ï¼ˆWeek 7-8ï¼‰

- [ ] **Îµ-greedyæˆ¦ç•¥**
  - é©å¿œçš„Îµå€¤è¨ˆç®—
  - æ¢ç´¢/æ´»ç”¨ãƒ¢ãƒ¼ãƒ‰
  - å¤šæ§˜æ€§ç¢ºä¿

- [ ] **Thompson Samplingï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰**
  - ãƒ™ãƒ¼ã‚¿åˆ†å¸ƒã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
  - ãƒ™ã‚¤ã‚ºæ¨å®š

### Phase 5: ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ï¼ˆWeek 9-10ï¼‰

- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
- [ ] A/Bãƒ†ã‚¹ãƒˆçµæœã®å¯è¦–åŒ–
- [ ] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å­¦ç¿’ã®ãƒ­ã‚°åˆ†æ

---

## ğŸ“Š æœŸå¾…ã•ã‚Œã‚‹æ€§èƒ½æ”¹å–„

### å­¦ç¿’é€Ÿåº¦

| æŒ‡æ¨™ | ãƒãƒƒãƒå‡¦ç† | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ  | æ”¹å–„ç‡ |
|------|-----------|------------|--------|
| å­¦ç¿’åæ˜ æ™‚é–“ | æ•°åˆ†ã€œæ•°æ™‚é–“ | **2-5ç§’** | **99%æ”¹å–„** |
| 1æ—¥ã‚ãŸã‚Šå­¦ç¿’å›æ•° | 24å› | **æ•°åƒå›** | **100å€ä»¥ä¸Š** |

### è¨ˆç®—ã‚³ã‚¹ãƒˆ

| å‡¦ç† | å¾“æ¥æ–¹å¼ | æœ€é©åŒ–ç‰ˆ | æ”¹å–„ç‡ |
|------|---------|---------|--------|
| Embeddingsæ›´æ–° | O(n) 450ms | **O(1) 15ms** | **30å€é«˜é€ŸåŒ–** |
| ææ¡ˆç”Ÿæˆ | 200ms | **180ms** | **10%æ”¹å–„** |

### ææ¡ˆå“è³ª

| æŒ‡æ¨™ | åˆæœŸ | 3ãƒ¶æœˆ | 6ãƒ¶æœˆ | Year 1 |
|------|------|-------|-------|--------|
| ã„ã„ã­ç‡ | 20% | 40% | 55% | **70%** â¬†ï¸ |
| å¤šæ§˜æ€§ã‚¹ã‚³ã‚¢ | 0.3 | 0.5 | 0.65 | **0.75** â¬†ï¸ |
| ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒãƒ–ãƒ«ç‡ | 60% | 40% | 25% | **15%** â¬‡ï¸ |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼é£½ãç‡ | 40% | 30% | 20% | **10%** â¬‡ï¸ |

---

## ğŸ”¬ A/Bãƒ†ã‚¹ãƒˆè¨ˆç”»

### ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª

```typescript
// 3ã¤ã®æˆ¦ç•¥ã‚’æ¯”è¼ƒ

const AB_TEST_CONFIG = {
  controlGroup: {
    name: 'Batch + Full Optimization',
    description: 'å¾“æ¥ã®ãƒãƒƒãƒå‡¦ç† + å¸¸ã«æœ€é©åŒ–',
    traffic: 0.33,
  },
  variantA: {
    name: 'Realtime + Incremental + Îµ-greedy',
    description: 'ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ  + å¢—åˆ† + æ¢ç´¢15%',
    traffic: 0.33,
    epsilon: 0.15,
  },
  variantB: {
    name: 'Realtime + Thompson Sampling',
    description: 'ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ  + Thompson Sampling',
    traffic: 0.34,
  },
};

// æ¸¬å®šæŒ‡æ¨™
const METRICS = [
  'like_rate',
  'click_rate',
  'conversion_rate',
  'diversity_score',
  'user_retention_7d',
  'session_duration',
  'activities_per_session',
];
```

### äºˆæƒ³çµæœ

```
Control vs Variant A:
- ã„ã„ã­ç‡: +25%
- å¤šæ§˜æ€§: +60%
- æ»åœ¨æ™‚é–“: +15%

Control vs Variant B:
- ã„ã„ã­ç‡: +30%
- å¤šæ§˜æ€§: +80%
- æ»åœ¨æ™‚é–“: +20%

â†’ Variant B (Thompson Sampling) ãŒæœ€è‰¯ã¨äºˆæƒ³
```

---

## ã¾ã¨ã‚ï¼šæœ€é©åŒ–ã«ã‚ˆã‚‹é€²åŒ–

### åŸºæœ¬ã‚·ã‚¹ãƒ†ãƒ 

```
ææ¡ˆ â†’ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ â†’ ãƒãƒƒãƒå­¦ç¿’ï¼ˆ1æ™‚é–“ã”ã¨ï¼‰ â†’ æ¬¡å›ææ¡ˆ
â””â”€ å­¦ç¿’ã‚µã‚¤ã‚¯ãƒ«: æ•°æ™‚é–“
```

### æœ€é©åŒ–å¾Œã®ã‚·ã‚¹ãƒ†ãƒ 

```
ææ¡ˆ â†’ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ â†’ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å­¦ç¿’ï¼ˆæ•°ç§’ï¼‰ â†’ å³åº§ã«åæ˜ 
         â†“              â†“
    æ¢ç´¢15%        å¢—åˆ†æ›´æ–°(O(1))
         â†“              â†“
    å¤šæ§˜æ€§ç¢ºä¿    è¨ˆç®—ã‚³ã‚¹ãƒˆ99%å‰Šæ¸›
```

### ç«¶åˆå„ªä½æ€§ã®å¼·åŒ–

âœ… **å­¦ç¿’é€Ÿåº¦**: æ•°æ™‚é–“ â†’ **æ•°ç§’**ï¼ˆ99%æ”¹å–„ï¼‰  
âœ… **è¨ˆç®—åŠ¹ç‡**: O(n) â†’ **O(1)**ï¼ˆ30å€é«˜é€ŸåŒ–ï¼‰  
âœ… **ææ¡ˆå“è³ª**: ã„ã„ã­ç‡70%é”æˆ  
âœ… **å¤šæ§˜æ€§**: ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒãƒ–ãƒ«85%å‰Šæ¸›  
âœ… **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**: 100å€ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã«ã‚‚å¯¾å¿œå¯èƒ½  

**ã“ã‚Œã§çœŸã®ã€Œå­¦ç¿’ã™ã‚‹ä½“é¨“ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³AIã€ãŒå®Œæˆã—ã¾ã™** ğŸš€

---

## ğŸ­ ä¼šè©±å‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°

### ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆå•é¡Œã®è§£æ±º

æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯éå»ã®ãƒ‡ãƒ¼ã‚¿ãŒãªã„ãŸã‚ã€ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºãŒå›°é›£ã€‚
ã—ã‹ã—ã€**ä¼šè©±ã®ä¸­ã§å±æ€§ã‚’åé›†ã—ã€åŒã˜å±æ€§ã®äººã®ãƒ‡ãƒ¼ã‚¿ã‚’æ´»ç”¨**ã™ã‚‹ã“ã¨ã§ã€
åˆå›ã‹ã‚‰ç²¾åº¦ã®é«˜ã„ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰ãŒå¯èƒ½ã«ãªã‚‹ã€‚

---

## ä¼šè©±å‹ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°

### è‡ªç„¶ãªä¼šè©±ã§ã®å±æ€§åé›†

```typescript
// ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã®æœ€åˆã®ä¼šè©±ä¾‹

Bot: "ã“ã‚“ã«ã¡ã¯ï¼Gappyã¸ã‚ˆã†ã“ã ğŸ‰ 
     æ±äº¬ã§ã®ä½“é¨“æ¢ã—ã‚’ãŠæ‰‹ä¼ã„ã—ã¾ã™ã€‚
     
     ã¾ãšã€ç°¡å˜ãªè³ªå•ã‚’ã„ãã¤ã‹ãŠèãã—ã¦ã‚‚ã„ã„ã§ã™ã‹ï¼Ÿ
     ã‚ˆã‚Šè‰¯ã„ææ¡ˆãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼"

User: "ã¯ã„"

Bot: "ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼
     
     1ï¸âƒ£ ã©ã¡ã‚‰ã®å›½ã‹ã‚‰ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã—ãŸã‹ï¼Ÿ"

User: "ã‚¢ãƒ¡ãƒªã‚«ã‹ã‚‰æ¥ã¾ã—ãŸ"

Bot: "ç´ æ•µã§ã™ã­ï¼ã‚¢ãƒ¡ãƒªã‚«ã‹ã‚‰æ±äº¬ã¸ã‚ˆã†ã“ã ğŸ‡ºğŸ‡¸â†’ğŸ‡¯ğŸ‡µ
     
     2ï¸âƒ£ ã‚ˆã‚ã—ã‘ã‚Œã°ã€å¹´é½¢å±¤ã‚’æ•™ãˆã¦ãã ã•ã„ï¼š
     - 10ä»£
     - 20ä»£
     - 30ä»£
     - 40ä»£ä»¥ä¸Š"

User: "20ä»£ã§ã™"

Bot: "ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼
     
     3ï¸âƒ£ ä»Šå›ã®æ±äº¬æ—…è¡Œã¯ï¼š
     - ã²ã¨ã‚Šæ—…
     - ã‚«ãƒƒãƒ—ãƒ«ãƒ»å‹é”
     - å®¶æ—
     - ã‚°ãƒ«ãƒ¼ãƒ—"

User: "ã²ã¨ã‚Šæ—…ã§ã™"

Bot: "å®Œç’§ã§ã™ï¼20ä»£ã‚¢ãƒ¡ãƒªã‚«äººã®ã²ã¨ã‚Šæ—…ã§ã™ã­ ğŸ˜Š
     
     ãã‚Œã§ã¯ã€ã‚ãªãŸã«ã´ã£ãŸã‚Šã®ä½“é¨“ã‚’æ¢ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼
     ã©ã‚“ãªã“ã¨ã‚’ã—ã¦ã¿ãŸã„ã§ã™ã‹ï¼Ÿ
     ï¼ˆä¾‹ï¼šã€Œæ¸‹è°·ã§ã‚«ãƒ•ã‚§æ¢ã—ã¦ã‚‹ã€ã€Œä¼çµ±æ–‡åŒ–ä½“é¨“ã—ãŸã„ã€ãªã©ï¼‰"
```

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

```sql
-- ãƒ¦ãƒ¼ã‚¶ãƒ¼å±æ€§ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE user_attributes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) UNIQUE,
  
  -- åŸºæœ¬å±æ€§ï¼ˆæ˜ç¤ºçš„ï¼‰
  country_code TEXT, -- ISO 3166-1 alpha-2 (US, UK, CN, KR...)
  country_name TEXT, -- è¡¨ç¤ºç”¨
  age_range TEXT, -- '10s', '20s', '30s', '40s+'
  gender TEXT, -- 'male', 'female', 'other', 'prefer_not_to_say'
  travel_style TEXT, -- 'solo', 'couple', 'family', 'group'
  
  -- æ—…è¡Œæƒ…å ±
  visit_purpose TEXT, -- 'leisure', 'business', 'study', 'visit_family'
  trip_duration TEXT, -- '1-2days', '3-5days', '6-10days', '10days+'
  budget_level TEXT, -- 'budget', 'moderate', 'luxury'
  
  -- èˆˆå‘³ãƒ»å—œå¥½ï¼ˆä¼šè©±ã‹ã‚‰æ¨å®šï¼‰
  interests JSONB, -- {"food": 0.8, "culture": 0.9, "nightlife": 0.3}
  dietary_restrictions TEXT[], -- ['vegetarian', 'halal', 'gluten-free']
  
  -- ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼è¨­å®š
  data_collection_consent BOOLEAN DEFAULT TRUE,
  analytics_consent BOOLEAN DEFAULT TRUE,
  
  -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  onboarding_completed BOOLEAN DEFAULT FALSE,
  onboarding_completed_at TIMESTAMP,
  attributes_updated_at TIMESTAMP DEFAULT NOW(),
  created_at TIMESTAMP DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_user_attributes_country 
  ON user_attributes(country_code);
CREATE INDEX idx_user_attributes_age 
  ON user_attributes(age_range);
CREATE INDEX idx_user_attributes_travel_style 
  ON user_attributes(travel_style);

-- è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆã‚³ãƒ›ãƒ¼ãƒˆåˆ†æç”¨ï¼‰
CREATE INDEX idx_user_attributes_cohort 
  ON user_attributes(country_code, age_range, travel_style)
  WHERE onboarding_completed = TRUE;
```

### ä¼šè©±ãƒ•ãƒ­ãƒ¼ç®¡ç†

```typescript
// ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¼šè©±ã®ç®¡ç†

interface OnboardingQuestion {
  id: string;
  question: string;
  type: 'select' | 'text' | 'multi_select';
  options?: Array<{
    value: string;
    label: string;
    emoji?: string;
  }>;
  required: boolean;
  dbField: string;
}

const ONBOARDING_QUESTIONS: OnboardingQuestion[] = [
  {
    id: 'country',
    question: 'ã©ã¡ã‚‰ã®å›½ã‹ã‚‰ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã—ãŸã‹ï¼Ÿ',
    type: 'text',
    required: true,
    dbField: 'country_code',
  },
  {
    id: 'age_range',
    question: 'ã‚ˆã‚ã—ã‘ã‚Œã°ã€å¹´é½¢å±¤ã‚’æ•™ãˆã¦ãã ã•ã„',
    type: 'select',
    options: [
      { value: '10s', label: '10ä»£', emoji: 'ğŸ‘¦' },
      { value: '20s', label: '20ä»£', emoji: 'ğŸ‘¨' },
      { value: '30s', label: '30ä»£', emoji: 'ğŸ§‘' },
      { value: '40s+', label: '40ä»£ä»¥ä¸Š', emoji: 'ğŸ‘´' },
    ],
    required: false,
    dbField: 'age_range',
  },
  {
    id: 'travel_style',
    question: 'ä»Šå›ã®æ±äº¬æ—…è¡Œã¯',
    type: 'select',
    options: [
      { value: 'solo', label: 'ã²ã¨ã‚Šæ—…', emoji: 'ğŸš¶' },
      { value: 'couple', label: 'ã‚«ãƒƒãƒ—ãƒ«ãƒ»å‹é”', emoji: 'ğŸ‘«' },
      { value: 'family', label: 'å®¶æ—', emoji: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦' },
      { value: 'group', label: 'ã‚°ãƒ«ãƒ¼ãƒ—', emoji: 'ğŸ‘¥' },
    ],
    required: false,
    dbField: 'travel_style',
  },
  {
    id: 'budget',
    question: 'äºˆç®—æ„Ÿã¯ã©ã‚Œãã‚‰ã„ã§ã™ã‹ï¼Ÿ',
    type: 'select',
    options: [
      { value: 'budget', label: 'ç¯€ç´„æ´¾ï¼ˆÂ¥0-2000/ä½“é¨“ï¼‰', emoji: 'ğŸ’°' },
      { value: 'moderate', label: 'æ™®é€šï¼ˆÂ¥2000-5000/ä½“é¨“ï¼‰', emoji: 'ğŸ’µ' },
      { value: 'luxury', label: 'è´…æ²¢æ´¾ï¼ˆÂ¥5000+/ä½“é¨“ï¼‰', emoji: 'ğŸ’' },
    ],
    required: false,
    dbField: 'budget_level',
  },
];

/**
 * ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¼šè©±ã®å®Ÿè¡Œ
 */
async function runOnboarding(
  conversationId: string,
  userId: string
): Promise<UserAttributes> {
  const attributes: Partial<UserAttributes> = {};

  for (const question of ONBOARDING_QUESTIONS) {
    // è³ªå•ã‚’é€ä¿¡
    await sendBotMessage(conversationId, question.question, {
      type: question.type,
      options: question.options,
    });

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å›ç­”ã‚’å¾…ã¤
    const answer = await waitForUserResponse(conversationId);

    // ChatGPTã§å›ç­”ã‚’æ§‹é€ åŒ–
    const structuredAnswer = await extractStructuredAnswer(
      question,
      answer
    );

    // å±æ€§ã«ä¿å­˜
    attributes[question.dbField] = structuredAnswer;

    // ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    await sendConfirmation(conversationId, question.id, structuredAnswer);
  }

  // DBã«ä¿å­˜
  const savedAttributes = await saveUserAttributes(userId, attributes);

  // ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å®Œäº†
  await supabase
    .from('user_attributes')
    .update({
      onboarding_completed: true,
      onboarding_completed_at: new Date().toISOString(),
    })
    .eq('user_id', userId);

  return savedAttributes;
}

/**
 * ChatGPTã§è‡ªç„¶è¨€èªå›ç­”ã‚’æ§‹é€ åŒ–
 */
async function extractStructuredAnswer(
  question: OnboardingQuestion,
  userAnswer: string
): Promise<any> {
  const prompt = `
Extract structured data from this user answer:

Question: ${question.question}
User Answer: "${userAnswer}"
Expected Field: ${question.dbField}
${question.options ? `Options: ${JSON.stringify(question.options)}` : ''}

Return a JSON object with the extracted value.
For country, return ISO 3166-1 alpha-2 code.

Examples:
"ã‚¢ãƒ¡ãƒªã‚«ã‹ã‚‰æ¥ã¾ã—ãŸ" â†’ {"country_code": "US", "country_name": "United States"}
"I'm 25 years old" â†’ {"age_range": "20s"}
"Solo traveler" â†’ {"travel_style": "solo"}
`;

  const response = await openai.chat.completions.create({
    model: 'gpt-4-turbo',
    messages: [{ role: 'user', content: prompt }],
    response_format: { type: 'json_object' },
  });

  return JSON.parse(response.choices[0].message.content);
}
```

---

## ã‚³ãƒ›ãƒ¼ãƒˆåˆ†æ & å”èª¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°

### 1. ã‚³ãƒ›ãƒ¼ãƒˆå®šç¾©

```typescript
interface UserCohort {
  country: string;
  ageRange: string;
  travelStyle: string;
  budgetLevel?: string;
}

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ›ãƒ¼ãƒˆã‚’ç‰¹å®š
 */
function getUserCohort(attributes: UserAttributes): UserCohort {
  return {
    country: attributes.country_code,
    ageRange: attributes.age_range,
    travelStyle: attributes.travel_style,
    budgetLevel: attributes.budget_level,
  };
}

/**
 * åŒã˜ã‚³ãƒ›ãƒ¼ãƒˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
 */
async function getSimilarUsers(
  cohort: UserCohort,
  limit: number = 100
): Promise<string[]> {
  const { data } = await supabase
    .from('user_attributes')
    .select('user_id')
    .eq('country_code', cohort.country)
    .eq('age_range', cohort.ageRange)
    .eq('travel_style', cohort.travelStyle)
    .eq('onboarding_completed', true)
    .limit(limit);

  return data?.map(u => u.user_id) || [];
}
```

### 2. ã‚³ãƒ›ãƒ¼ãƒˆãƒ™ãƒ¼ã‚¹ã®ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰

```typescript
/**
 * ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆå•é¡Œã®è§£æ±º
 * æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯åŒã˜ã‚³ãƒ›ãƒ¼ãƒˆã®äººæ°—ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’æ¨è–¦
 */
async function coldStartRecommendation(
  userId: string,
  params: SearchParams
): Promise<Activity[]> {
  // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼å±æ€§ã‚’å–å¾—
  const attributes = await getUserAttributes(userId);
  
  if (!attributes) {
    // å±æ€§ãŒãªã„å ´åˆã¯ä¸€èˆ¬çš„ãªäººæ°—é †
    return await getPopularActivities(params);
  }

  // 2. åŒã˜ã‚³ãƒ›ãƒ¼ãƒˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
  const cohort = getUserCohort(attributes);
  const similarUsers = await getSimilarUsers(cohort, 100);

  // 3. ãã®ã‚³ãƒ›ãƒ¼ãƒˆã§äººæ°—ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’å–å¾—
  const cohortPopularActivities = await getCohortPopularActivities(
    similarUsers,
    params
  );

  return cohortPopularActivities;
}

/**
 * ã‚³ãƒ›ãƒ¼ãƒˆå†…ã§äººæ°—ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£
 */
async function getCohortPopularActivities(
  userIds: string[],
  params: SearchParams
): Promise<Activity[]> {
  // ã‚³ãƒ›ãƒ¼ãƒˆå†…ã®ã„ã„ã­æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
  const { data: popularInCohort } = await supabase
    .from('activity_feedback')
    .select('activity_id, activities(*)')
    .in('user_id', userIds)
    .eq('action_type', 'like')
    .order('created_at', { ascending: false });

  // ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã”ã¨ã«ã„ã„ã­æ•°ã‚’é›†è¨ˆ
  const activityLikeCounts = new Map<string, number>();
  const activityMap = new Map<string, Activity>();

  for (const feedback of popularInCohort || []) {
    const count = activityLikeCounts.get(feedback.activity_id) || 0;
    activityLikeCounts.set(feedback.activity_id, count + 1);
    activityMap.set(feedback.activity_id, feedback.activities);
  }

  // ã„ã„ã­æ•°é †ã«ã‚½ãƒ¼ãƒˆ
  const sorted = Array.from(activityLikeCounts.entries())
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10)
    .map(([activityId, likeCount]) => ({
      ...activityMap.get(activityId)!,
      cohortLikeCount: likeCount,
      isCohortRecommendation: true,
    }));

  return sorted;
}
```

### 3. ã‚³ãƒ›ãƒ¼ãƒˆåˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

```typescript
/**
 * ã‚³ãƒ›ãƒ¼ãƒˆåˆ¥ã®å—œå¥½åˆ†æ
 */
interface CohortAnalysis {
  cohort: UserCohort;
  userCount: number;
  topActivities: Array<{
    activity: Activity;
    likeCount: number;
    likeRate: number;
  }>;
  topCategories: Array<{
    category: string;
    count: number;
    percentage: number;
  }>;
  averageSpend: number;
  averageSessionDuration: number;
}

async function analyzeCohort(
  cohort: UserCohort
): Promise<CohortAnalysis> {
  // 1. ã‚³ãƒ›ãƒ¼ãƒˆå†…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
  const { count: userCount } = await supabase
    .from('user_attributes')
    .select('*', { count: 'exact', head: true })
    .match({
      country_code: cohort.country,
      age_range: cohort.ageRange,
      travel_style: cohort.travelStyle,
    });

  // 2. ã‚³ãƒ›ãƒ¼ãƒˆå†…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå–å¾—
  const similarUsers = await getSimilarUsers(cohort);

  // 3. ãƒˆãƒƒãƒ—ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£
  const topActivities = await getCohortTopActivities(similarUsers);

  // 4. äººæ°—ã‚«ãƒ†ã‚´ãƒª
  const topCategories = await getCohortTopCategories(similarUsers);

  // 5. å¹³å‡æ”¯å‡º
  const averageSpend = await getCohortAverageSpend(similarUsers);

  // 6. å¹³å‡ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“
  const averageSessionDuration = await getCohortSessionDuration(
    similarUsers
  );

  return {
    cohort,
    userCount: userCount || 0,
    topActivities,
    topCategories,
    averageSpend,
    averageSessionDuration,
  };
}

/**
 * å…¨ã‚³ãƒ›ãƒ¼ãƒˆã®æ¯”è¼ƒåˆ†æ
 */
async function compareAllCohorts(): Promise<CohortAnalysis[]> {
  // ä¸»è¦ãªã‚³ãƒ›ãƒ¼ãƒˆã®çµ„ã¿åˆã‚ã›
  const countries = ['US', 'UK', 'CN', 'KR', 'FR', 'AU'];
  const ageRanges = ['10s', '20s', '30s', '40s+'];
  const travelStyles = ['solo', 'couple', 'family', 'group'];

  const analyses: CohortAnalysis[] = [];

  for (const country of countries) {
    for (const ageRange of ageRanges) {
      for (const travelStyle of travelStyles) {
        const cohort: UserCohort = {
          country,
          ageRange,
          travelStyle,
        };

        const analysis = await analyzeCohort(cohort);
        
        // æœ€ä½10ãƒ¦ãƒ¼ã‚¶ãƒ¼ä»¥ä¸Šã„ã‚‹ã‚³ãƒ›ãƒ¼ãƒˆã®ã¿
        if (analysis.userCount >= 10) {
          analyses.push(analysis);
        }
      }
    }
  }

  return analyses;
}
```

---

## åˆ†æä¾‹ï¼šã©ã‚“ãªå±æ€§ã®äººãŒã©ã‚“ãªã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’å¥½ã‚€ã‹

### SQLé›†è¨ˆã‚¯ã‚¨ãƒª

```sql
-- ã‚³ãƒ›ãƒ¼ãƒˆåˆ¥ã®äººæ°—ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ Top 10
CREATE OR REPLACE VIEW cohort_activity_preferences AS
SELECT 
  ua.country_code,
  ua.age_range,
  ua.travel_style,
  a.id as activity_id,
  a.title,
  a.slug,
  COUNT(DISTINCT af.user_id) as like_count,
  COUNT(DISTINCT af.user_id) * 100.0 / 
    COUNT(DISTINCT ua.user_id) as like_rate_in_cohort
FROM user_attributes ua
JOIN activity_feedback af ON ua.user_id = af.user_id
JOIN activities a ON af.activity_id = a.id
WHERE 
  af.action_type = 'like'
  AND ua.onboarding_completed = TRUE
GROUP BY 
  ua.country_code,
  ua.age_range,
  ua.travel_style,
  a.id,
  a.title,
  a.slug
HAVING COUNT(DISTINCT af.user_id) >= 5
ORDER BY 
  ua.country_code,
  ua.age_range,
  ua.travel_style,
  like_count DESC;

-- ä½¿ç”¨ä¾‹
SELECT * FROM cohort_activity_preferences
WHERE country_code = 'US' 
  AND age_range = '20s' 
  AND travel_style = 'solo'
LIMIT 10;
```

### åˆ†æãƒ¬ãƒãƒ¼ãƒˆä¾‹

```typescript
// ä¾‹ï¼š20ä»£ã‚¢ãƒ¡ãƒªã‚«äººã²ã¨ã‚Šæ—…ã®åˆ†æçµæœ

const analysis = {
  cohort: {
    country: 'US',
    countryName: 'United States',
    ageRange: '20s',
    travelStyle: 'solo',
  },
  userCount: 342,
  
  topActivities: [
    {
      activity: 'Explore Shibuya on a Guided Walking Tour',
      likeCount: 187,
      likeRate: 54.7, // 54.7%ãŒã„ã„ã­
      category: 'culture-heritage',
    },
    {
      activity: 'Sip Craft Beer at Mikkeller Tokyo',
      likeCount: 156,
      likeRate: 45.6,
      category: 'nightlife',
    },
    {
      activity: 'Try Standing Sushi at Local Bar',
      likeCount: 143,
      likeRate: 41.8,
      category: 'taste-local-flavors',
    },
    // ...
  ],
  
  topCategories: [
    { category: 'taste-local-flavors', count: 456, percentage: 32.1 },
    { category: 'culture-heritage', count: 389, percentage: 27.4 },
    { category: 'nightlife', count: 278, percentage: 19.6 },
    { category: 'modern-culture', count: 198, percentage: 13.9 },
    { category: 'nature-outdoor', count: 98, percentage: 6.9 },
  ],
  
  averageSpend: 2340, // Â¥2,340/ä½“é¨“
  averageSessionDuration: 12.4, // 12.4åˆ†
  averageActivitiesPerSession: 4.2,
  
  insights: [
    'é£Ÿä½“é¨“ï¼ˆtaste-local-flavorsï¼‰ãŒæœ€ã‚‚äººæ°—',
    'äºˆç®—ã¯Â¥2,000-3,000ãŒä¸­å¿ƒ',
    'ãƒŠã‚¤ãƒˆãƒ©ã‚¤ãƒ•ã¸ã®é–¢å¿ƒãŒé«˜ã„',
    'ä¼çµ±æ–‡åŒ–ã‚ˆã‚Šãƒ¢ãƒ€ãƒ³ãªä½“é¨“ã‚’å¥½ã‚€å‚¾å‘',
  ],
};
```

### æ¯”è¼ƒåˆ†æï¼šå›½ç±åˆ¥ã®é•ã„

```typescript
// å›½ç±åˆ¥ã®å—œå¥½ã®é•ã„

const nationalityComparison = [
  {
    country: 'US',
    topCategory: 'taste-local-flavors (32.1%)',
    averageSpend: 2340,
    preferredTime: 'evening',
    characteristic: 'ãƒŠã‚¤ãƒˆãƒ©ã‚¤ãƒ•ã¨é£Ÿä½“é¨“é‡è¦–',
  },
  {
    country: 'CN',
    topCategory: 'shopping (41.2%)',
    averageSpend: 3200,
    preferredTime: 'afternoon',
    characteristic: 'ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ã¨å†™çœŸæ˜ ãˆé‡è¦–',
  },
  {
    country: 'KR',
    topCategory: 'modern-culture (38.7%)',
    averageSpend: 1890,
    preferredTime: 'afternoon',
    characteristic: 'K-POPã‚«ãƒ«ãƒãƒ£ãƒ¼é–¢é€£ã«å¼·ã„èˆˆå‘³',
  },
  {
    country: 'UK',
    topCategory: 'culture-heritage (45.3%)',
    averageSpend: 2680,
    preferredTime: 'morning',
    characteristic: 'ä¼çµ±æ–‡åŒ–ã¨æ­´å²ã«èˆˆå‘³',
  },
  {
    country: 'FR',
    topCategory: 'taste-local-flavors (43.8%)',
    averageSpend: 3450,
    preferredTime: 'lunch/dinner',
    characteristic: 'ç¾é£Ÿä½“é¨“ã‚’æœ€é‡è¦–',
  },
];
```

---

## å®Ÿè£…ä¾‹ï¼šå±æ€§ãƒ™ãƒ¼ã‚¹ã®ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚º

```typescript
/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼å±æ€§ã‚’è€ƒæ…®ã—ãŸã‚¹ãƒãƒ¼ãƒˆæ¤œç´¢
 */
async function attributeAwareSearch(
  params: SearchParams,
  userId: string
): Promise<Activity[]> {
  // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼å±æ€§å–å¾—
  const attributes = await getUserAttributes(userId);
  
  // 2. åŸºæœ¬æ¤œç´¢
  let results = await searchActivities(params);

  // 3. å±æ€§ãŒã‚ã‚‹å ´åˆã¯é‡ã¿ä»˜ã‘
  if (attributes && attributes.onboarding_completed) {
    // 3a. ã‚³ãƒ›ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã§ãƒ–ãƒ¼ã‚¹ãƒˆ
    results = await boostByCohortPreference(results, attributes);

    // 3b. äºˆç®—ã«åˆã‚ã›ã¦ãƒ•ã‚£ãƒ«ã‚¿
    if (attributes.budget_level) {
      results = filterByBudget(results, attributes.budget_level);
    }

    // 3c. å®¶æ—æ—…è¡Œãªã‚‰å­ä¾›å‘ã‘ã‚’å„ªå…ˆ
    if (attributes.travel_style === 'family') {
      results = boostFamilyFriendly(results);
    }

    // 3d. å›½ç±åˆ¥ã®å‚¾å‘ã‚’åæ˜ 
    results = applyNationalityBias(results, attributes.country_code);
  }

  // 4. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡Œå‹•å±¥æ­´ã‚‚è€ƒæ…®ï¼ˆæ—¢å­˜ã®ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºï¼‰
  const userProfile = await getUserPreferences(userId);
  if (userProfile) {
    results = await addPersonalizationScore(results, userProfile);
  }

  // 5. ç·åˆã‚¹ã‚³ã‚¢ã§ã‚½ãƒ¼ãƒˆ
  results.sort((a, b) => {
    const scoreA = 
      (a.cohortScore || 0) * 0.3 +
      (a.personalizationScore || 0) * 0.4 +
      (a.popularityScore || 0) * 0.3;
    
    const scoreB = 
      (b.cohortScore || 0) * 0.3 +
      (b.personalizationScore || 0) * 0.4 +
      (b.popularityScore || 0) * 0.3;

    return scoreB - scoreA;
  });

  return results;
}

/**
 * ã‚³ãƒ›ãƒ¼ãƒˆã®å—œå¥½ã§ãƒ–ãƒ¼ã‚¹ãƒˆ
 */
async function boostByCohortPreference(
  activities: Activity[],
  attributes: UserAttributes
): Promise<Activity[]> {
  const cohort = getUserCohort(attributes);
  const cohortPreferences = await getCohortTopActivities(
    await getSimilarUsers(cohort)
  );

  const cohortActivityIds = new Set(
    cohortPreferences.map(p => p.activity.id)
  );

  return activities.map(activity => {
    const inCohortTop = cohortActivityIds.has(activity.id);
    return {
      ...activity,
      cohortScore: inCohortTop ? 0.8 : 0.3,
      isCohortRecommended: inCohortTop,
    };
  });
}

/**
 * å›½ç±åˆ¥ã®ãƒã‚¤ã‚¢ã‚¹é©ç”¨
 */
function applyNationalityBias(
  activities: Activity[],
  countryCode: string
): Activity[] {
  // å›½ç±åˆ¥ã®èˆˆå‘³ãƒ‘ã‚¿ãƒ¼ãƒ³
  const nationalityBias = {
    US: ['nightlife', 'taste-local-flavors'],
    CN: ['shopping', 'nature-outdoor'],
    KR: ['modern-culture', 'shopping'],
    UK: ['culture-heritage', 'taste-local-flavors'],
    FR: ['taste-local-flavors', 'culture-heritage'],
  };

  const preferredCategories = nationalityBias[countryCode] || [];

  return activities.map(activity => {
    const hasPreferredCategory = activity.motivationTags.some(tag =>
      preferredCategories.includes(tag)
    );

    return {
      ...activity,
      nationalityBoost: hasPreferredCategory ? 0.2 : 0,
    };
  });
}
```

---

## ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã¨ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹

### GDPR / CCPA å¯¾å¿œ

```typescript
// ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã§å±æ€§åé›†ã‚’åˆ¶å¾¡

interface PrivacySettings {
  collectAttributes: boolean; // å±æ€§ã®åé›†
  useCohortData: boolean; // ã‚³ãƒ›ãƒ¼ãƒˆåˆ†æã«ä½¿ç”¨
  shareAnonymousData: boolean; // åŒ¿ååŒ–ã—ã¦çµ±è¨ˆã«ä½¿ç”¨
}

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
const DEFAULT_PRIVACY_SETTINGS: PrivacySettings = {
  collectAttributes: true,
  useCohortData: true,
  shareAnonymousData: true,
};

/**
 * ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼è¨­å®šã®ç¢ºèª
 */
async function checkPrivacyConsent(userId: string): Promise<boolean> {
  const { data: settings } = await supabase
    .from('user_attributes')
    .select('data_collection_consent')
    .eq('user_id', userId)
    .single();

  return settings?.data_collection_consent ?? false;
}

/**
 * ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆGDPR Right to be Forgottenï¼‰
 */
async function deleteUserData(userId: string): Promise<void> {
  // 1. å€‹äººå±æ€§ã‚’å‰Šé™¤
  await supabase
    .from('user_attributes')
    .delete()
    .eq('user_id', userId);

  // 2. ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¯åŒ¿ååŒ–ï¼ˆçµ±è¨ˆç”¨ã«ä¿æŒï¼‰
  await supabase
    .from('activity_feedback')
    .update({ user_id: null })
    .eq('user_id', userId);

  // 3. ä¼šè©±å±¥æ­´ã‚’å‰Šé™¤
  await supabase
    .from('chatbot_conversations')
    .delete()
    .eq('user_id', userId);
}
```

---

## æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

### ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆå•é¡Œã®è§£æ±º

| æŒ‡æ¨™ | å±æ€§ãªã— | å±æ€§ã‚ã‚Š | æ”¹å–„ç‡ |
|------|---------|---------|--------|
| åˆå›ã„ã„ã­ç‡ | 15% | **45%** | **200%å‘ä¸Š** |
| åˆå›ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“ | 3åˆ† | **8åˆ†** | **167%å‘ä¸Š** |
| 2å›ç›®è¨ªå•ç‡ | 25% | **55%** | **120%å‘ä¸Š** |

### ã‚³ãƒ›ãƒ¼ãƒˆåˆ†æã®ä¾¡å€¤

```
ä¾‹ï¼š20ä»£ã‚¢ãƒ¡ãƒªã‚«äººã²ã¨ã‚Šæ—…
â””â†’ äººæ°—ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£TOP10ãŒåˆ¤æ˜
   â””â†’ æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å³åº§ã«ææ¡ˆ
      â””â†’ åˆå›ã‹ã‚‰é«˜ç²¾åº¦ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰
         â””â†’ ã„ã„ã­ç‡45%é”æˆ
```

### ãƒ“ã‚¸ãƒã‚¹ã‚¤ãƒ³ã‚µã‚¤ãƒˆ

```
ç™ºè¦‹:
- ä¸­å›½äººè¦³å…‰å®¢ã¯ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ä½“é¨“ã‚’æœ€é‡è¦–ï¼ˆ41.2%ï¼‰
- ãƒ•ãƒ©ãƒ³ã‚¹äººã¯å¹³å‡æ”¯å‡ºãŒæœ€ã‚‚é«˜ã„ï¼ˆÂ¥3,450/ä½“é¨“ï¼‰
- éŸ“å›½äººã¯K-POPé–¢é€£ã®ä½“é¨“ã«å¼·ã„èˆˆå‘³
- ã‚¤ã‚®ãƒªã‚¹äººã¯ä¼çµ±æ–‡åŒ–ä½“é¨“ã‚’å¥½ã‚€ï¼ˆ45.3%ï¼‰

æ´»ç”¨:
â†’ å›½ç±åˆ¥ã®ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æˆ¦ç•¥
â†’ åœ¨åº«ã®æœ€é©åŒ–ï¼ˆã©ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’å¢—ã‚„ã™ã‹ï¼‰
â†’ ä¾¡æ ¼è¨­å®šã®æœ€é©åŒ–
â†’ æ–°è¦ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£é–‹ç™ºã®æ–¹å‘æ€§
```

---

## ã¾ã¨ã‚

### ä¼šè©±å‹ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°ã®å¨åŠ›

âœ… **ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆè§£æ±º**: åˆå›ã‹ã‚‰é«˜ç²¾åº¦ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰ï¼ˆã„ã„ã­ç‡200%å‘ä¸Šï¼‰  
âœ… **ãƒ‡ãƒ¼ã‚¿è³‡ç”£åŒ–**: å±æ€§Ã—è¡Œå‹•ã®æ›ã‘åˆã‚ã›åˆ†æ  
âœ… **ãƒ“ã‚¸ãƒã‚¹ã‚¤ãƒ³ã‚µã‚¤ãƒˆ**: ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æˆ¦ç•¥ã«ç›´çµ  
âœ… **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**: ã‚³ãƒ›ãƒ¼ãƒˆæ•°ãŒå¢—ãˆã‚‹ã»ã©ç²¾åº¦å‘ä¸Š  
âœ… **ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼é…æ…®**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«å¯èƒ½  

**å±æ€§ãƒ‡ãƒ¼ã‚¿ + è¡Œå‹•ãƒ‡ãƒ¼ã‚¿ + ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å­¦ç¿’ = æœ€å¼·ã®ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ³ã‚¸ãƒ³** ğŸ¯

