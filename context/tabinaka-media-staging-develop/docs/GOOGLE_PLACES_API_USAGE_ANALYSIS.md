# Google Places API 使用状況分析

## 概要
このドキュメントは、プロジェクト内でのGoogle Places APIの呼び出し回数と使用パターンを分析したものです。

---

## 1. おすすめ機能 (`/api/recommend.ts`)

### 場面
ユーザーがオンボーディングクイズを完了した後、おすすめ場所を生成する際

### API呼び出し回数

#### 検索フェーズ
- **Nearby Search API**: `types.slice(0, 3)` = **最大3回**（並列実行）
  - 各カテゴリータイプごとに1回ずつ
  - 例: `restaurant`, `cafe`, `bakery` など

#### リトライ（結果が0件の場合）
- **Nearby Search API**: 再度 **最大3回**（並列実行）
  - 半径を1.5倍に拡大して再検索

#### 詳細取得フェーズ
- **Place Details API**: `places.slice(0, 10)` = **最大10回**（並列実行）
  - 上位10件の場所の詳細情報を取得

### 合計呼び出し回数
- **ベストケース**: 3回（Nearby Search） + 10回（Place Details） = **13回**
- **ワーストケース**: 3回（1回目） + 3回（リトライ） + 10回（Place Details） = **16回**
- **平均**: 約 **14-15回**

---

## 2. AIチャット検索 (`/api/chat/send-message.ts` → `lib/functionRegistry.ts`)

### 場面
ユーザーがチャットで「渋谷でレストラン探して」などと検索する際

### API呼び出し回数

#### 戦略による検索
`executeSearchPlaces`関数内で、複数の戦略を順番に試行：

**カテゴリー別の戦略数**:
- **make（作る）**: 3つの戦略
- **feel（感じる）**: 2つの戦略
- **eat（食べる）**: 4つの戦略
- **learn（学ぶ）**: 1つの戦略
- **play（遊ぶ）**: 1つの戦略

**各戦略での呼び出し**:
- `searchWithTypes`関数内で、`types`配列の各要素に対して順番に検索
- 成功したら即座にreturn（早期終了）

**primaryTypesでの検索**:
- 各戦略の`primaryTypes`配列の各要素に対して順次検索
- 例: `['restaurant', 'food']` → 最大2回
- **結果が見つかったら即座に終了**

**fallbackTypesでの検索**（primaryTypesで結果なしの場合）:
- 各戦略の`fallbackTypes`配列の各要素に対して順次検索
- 例: `['cafe', 'bakery']` → 最大2回

### 呼び出しパターン例

#### eat（食べる）カテゴリーの場合
戦略1:
- primaryTypes: `['restaurant']` → **1回**
- 成功すれば終了

戦略2（戦略1が失敗した場合）:
- primaryTypes: `['cafe']` → **1回**
- 成功すれば終了

戦略3（戦略2が失敗した場合）:
- primaryTypes: `['meal_takeaway']` → **1回**
- 成功すれば終了

戦略4（戦略3が失敗した場合）:
- primaryTypes: `['bakery']` → **1回**
- 成功すれば終了

### 合計呼び出し回数
- **ベストケース**: **1回**（最初の戦略の最初のtypeで成功）
- **ワーストケース**: 
  - eat: 4戦略 × 平均1.5回 = **約6-8回**
  - make: 3戦略 × 平均2回 = **約6-8回**
  - feel: 2戦略 × 平均2回 = **約4-5回**
- **平均**: **2-4回**

### 注意点
- `searchWithTypes`は**順次実行**（forループ内でawait）
- 結果が見つかったら即座にreturnするため、実際の呼び出し回数は少ない傾向

---

## 3. 直接検索 (`/api/places/search.ts`)

### 場面
フロントエンドから直接検索APIを呼び出す際

### API呼び出し回数
- **Text Search API**: **1回**
- または **Nearby Search API**: **1回**

### 合計呼び出し回数
**1回**

---

## 4. 場所詳細取得 (`/api/places/details.ts`)

### 場面
特定の場所の詳細情報を取得する際

### API呼び出し回数
- **Place Details API**: **1回**

### 合計呼び出し回数
**1回**

---

## 5. 写真取得 (`/api/places/photo.ts`, `/api/places/photo-legacy.ts`)

### 場面
場所の写真を表示する際

### API呼び出し回数
- **Place Photo API**: **1回/写真**

### 合計呼び出し回数
**1回/リクエスト**

---

## 6. ジオコーディング (`/api/places/geocode.ts`)

### 場面
住所から座標を取得する際

### API呼び出し回数
- **Geocoding API**: **1回**

### 合計呼び出し回数
**1回**

---

## 7. レビュー取得 (`/api/google-places-reviews.ts`)

### 場面
場所のレビュー情報を取得する際

### API呼び出し回数
- **Place Details API** (reviewsフィールド): **1回**

### 合計呼び出し回数
**1回**

---

## 9. エクスペリエンス一覧での星評価取得

### 場面
エクスペリエンス一覧ページ（`/experiences`）で各エクスペリエンスカードに星評価を表示する際

### 使用コンポーネント
- `ExperienceGrid` - グリッド表示
- `ExperienceCard` - カード表示
- `ExperiencesCarousel` - カルーセル表示

### API呼び出しパターン

各エクスペリエンスカードに`GoogleMapsRating`コンポーネントが使用されています。

#### キャッシュ戦略
1. **クライアント側（localStorage）**: 24時間のTTL
2. **サーバー側（apiCache）**: `CACHE_TTL.PLACE_REVIEWS`に基づく

#### 初期表示
- 初期表示件数: **20件**
- 各エクスペリエンスが`googlePlaceId`を持っている場合、最大**20個の`GoogleMapsRating`コンポーネント**がマウントされる
- 各コンポーネントは**並列でAPIを呼び出す**可能性がある

#### Load More
- 「Load More」ボタンで+20件ずつ追加表示
- 追加20件ごとに、最大**20回のAPI呼び出し**が追加される可能性

### API呼び出し回数

#### 初回アクセス時（キャッシュなし）
- **Place Details API**: 最大**20回**（並列実行）
  - 各エクスペリエンスカードごとに1回
  - 全てのエクスペリエンスが`googlePlaceId`を持っている場合

#### 2回目以降のアクセス（キャッシュあり）
- **Place Details API**: **0回**
  - localStorageのキャッシュ（24時間有効）を使用
  - サーバー側キャッシュも有効であればAPI呼び出しなし

#### Load More使用時
- 追加20件表示時: 最大**20回**（キャッシュなしの場合）
- 追加40件表示時: 最大**40回**（キャッシュなしの場合）

### 合計呼び出し回数
- **初回アクセス時（20件表示）**: 最大**20回**（並列実行）
- **Load More使用時（追加20件）**: 最大**+20回**
- **キャッシュありの場合**: **0回**

### 注意点
1. **並列実行によるAPI呼び出し**
   - 全ての`GoogleMapsRating`コンポーネントが同時にマウントされ、並列でAPIを呼び出す
   - 20件表示の場合、理論上最大20回のAPIリクエストが同時に発生する可能性

2. **キャッシュの効果**
   - localStorageのキャッシュにより、2回目以降のアクセスではAPI呼び出しが発生しない（24時間以内）
   - サーバー側キャッシュも有効であれば、初回アクセス時でもAPI呼び出しが削減される

3. **`googlePlaceId`の有無**
   - `googlePlaceId`が設定されていないエクスペリエンスは、API呼び出しが発生しない
   - 実際の呼び出し回数は、`googlePlaceId`を持つエクスペリエンスの数に依存

### 最適化の余地
- **バッチ取得の実装**: 複数の`placeId`を一度に取得するAPIエンドポイントの作成
- **SSR/SSGでの事前取得**: ビルド時またはサーバーサイドで評価情報を取得
- **遅延読み込み**: ビューポートに入ったエクスペリエンスのみ評価を取得

---

## 8. 移動時間計算 (`lib/functionRegistry.ts` → `executeCalculateTravelTime`)

### 場面
AIチャットで「この場所までどう行けばいい？」と質問された際

### API呼び出し回数
- **Geocoding API**: 目的地の座標が不明な場合、**1回**
- **Directions API**: **1回**

### 合計呼び出し回数
**1-2回**（目的地の座標が既に分かっている場合は1回）

---

## 合計呼び出し回数まとめ

### シナリオ別の呼び出し回数

| シナリオ | 最小 | 最大 | 平均 |
|---------|------|------|------|
| おすすめ生成 | 13回 | 16回 | 14-15回 |
| AIチャット検索（eat） | 1回 | 8回 | 2-4回 |
| AIチャット検索（make） | 1回 | 8回 | 2-4回 |
| AIチャット検索（feel） | 1回 | 5回 | 2-3回 |
| 直接検索 | 1回 | 1回 | 1回 |
| 場所詳細取得 | 1回 | 1回 | 1回 |
| 写真取得 | 1回 | 1回 | 1回 |
| レビュー取得 | 1回 | 1回 | 1回 |
| 移動時間計算 | 1回 | 2回 | 1-2回 |
| **エクスペリエンス一覧（初回）** | **0回** | **20回** | **10-15回** |
| **エクスペリエンス一覧（キャッシュあり）** | **0回** | **0回** | **0回** |

### 典型的なユーザージャーニーでの呼び出し回数

#### ケース1: オンボーディング → おすすめ表示
- おすすめ生成: **14-15回**
- 合計: **14-15回**

#### ケース2: チャットで検索 → 詳細表示
- チャット検索: **2-4回**
- 場所詳細（複数件）: **5-10回**（並列）
- 合計: **7-14回**

#### ケース3: チャットで検索 → 移動時間計算
- チャット検索: **2-4回**
- 移動時間計算: **1-2回**
- 合計: **3-6回**

#### ケース4: エクスペリエンス一覧ページ表示
- 初回アクセス（20件表示）: **最大20回**（並列実行）
- 2回目以降（キャッシュあり）: **0回**
- Load More使用時（+20件）: **最大+20回**

---

## 使用されているAPIエンドポイント

1. **Nearby Search** (`/place/nearbysearch/json`)
   - 最も頻繁に使用
   - おすすめ機能、チャット検索で使用

2. **Place Details** (`/place/details/json`)
   - 2番目に頻繁に使用
   - 詳細情報、レビュー取得で使用

3. **Text Search** (`/place/textsearch/json`)
   - 直接検索で使用

4. **Place Photo** (`/place/photo`)
   - 写真表示で使用

5. **Geocoding** (`/geocode/json`)
   - 住所→座標変換で使用

6. **Directions** (`/directions/json`)
   - ルート検索で使用

---

## 並列実行の有無

### 並列実行されている箇所
1. **おすすめ機能** (`/api/recommend.ts`)
   - Nearby Search: 3回を並列実行
   - Place Details: 10回を並列実行

2. **エクスペリエンス一覧** (`components/ExperienceGrid.tsx`など)
   - Place Details (星評価): 最大20回を並列実行
   - 各`GoogleMapsRating`コンポーネントが個別にAPIを呼び出す

### 順次実行されている箇所
1. **AIチャット検索** (`lib/functionRegistry.ts`)
   - `searchWithTypes`内のforループは順次実行
   - 結果が見つかったら即座に終了

---

## コスト最適化のポイント

1. **キャッシュの活用**
   - `lib/cache.ts`でPlace Detailsをキャッシュ
   - TTL設定により、同じ場所の詳細は再取得しない

2. **早期終了**
   - チャット検索では、結果が見つかったら即座に終了
   - 不要なAPI呼び出しを削減

3. **並列実行**
   - おすすめ機能では並列実行により、レスポンス時間を短縮

4. **リトライ戦略**
   - 結果が0件の場合のみリトライ
   - 無駄な呼び出しを最小化

---

## 推奨事項

1. **API呼び出し回数の監視**
   - Google Cloud ConsoleでAPI使用量を監視
   - 特に、おすすめ機能は1回のリクエストで14-15回呼び出されるため注意
   - **エクスペリエンス一覧ページは初回アクセス時に最大20回のAPI呼び出しが発生する可能性**があるため、特に注意が必要

2. **キャッシュの拡充**
   - 検索結果もキャッシュすることを検討
   - 同じクエリは一定時間キャッシュから返す

3. **リトライロジックの最適化**
   - 現在は半径を1.5倍に拡大してリトライ
   - より効率的なリトライ戦略を検討

4. **バッチ処理の検討**
   - 複数のPlace Details取得を1つのリクエストにまとめる（可能な場合）

---

## 構造上の問題点と無駄なAPI呼び出し

### 1. エクスペリエンス一覧での個別API呼び出し（重大）

#### 問題
- **個別コンポーネントによる並列呼び出し**: `ExperienceGrid`で20個の`GoogleMapsRating`コンポーネントが同時にマウントされ、それぞれが個別にAPIを呼び出す
- **バッチ取得ができない**: 複数の`placeId`を一度に取得する仕組みがない
- **重複リクエストの可能性**: 同じ`placeId`に対して、複数のコンポーネントが同時にAPIを呼ぶ可能性がある
  - 異なるエクスペリエンスが同じ場所を指している場合
  - 初回アクセス時、localStorageにキャッシュがないため、全てのコンポーネントがAPIを呼ぶ

#### 影響
- **初回アクセス時**: 最大20回のAPI呼び出しが同時に発生
- **同じplaceIdの重複**: 同じ場所を指す複数のエクスペリエンスがある場合、同じAPIを複数回呼ぶ

#### 解決策
1. **バッチ取得APIの実装**: 複数の`placeId`を一度に取得するエンドポイントを作成
2. **グローバルなリクエストキュー**: 同じ`placeId`に対するリクエストを1つにまとめる
3. **遅延読み込み**: ビューポートに入ったエクスペリエンスのみAPIを呼ぶ（Intersection Observer API）

### 2. GoogleMapsReviewsコンポーネントのキャッシュ不足

#### 問題
- `GoogleMapsReviews`コンポーネントは`GoogleMapsRating`と同じAPIエンドポイント（`/api/google-places-reviews`）を使用
- しかし、**localStorageキャッシュを使用していない**
- `GoogleMapsRating`と`GoogleMapsReviews`が同じページで使用される場合、同じ`placeId`に対して2回APIを呼ぶ可能性がある

#### 影響
- 同じページで両方のコンポーネントが使用される場合、同じAPIを2回呼ぶ

#### 解決策
- `GoogleMapsReviews`でもlocalStorageキャッシュを使用する
- または、両コンポーネントで共通のキャッシュ管理を行う

### 3. ビューポート外のエクスペリエンスのAPI呼び出し

#### 問題
- エクスペリエンス一覧ページで、**画面外（スクロールしないと見えない）のエクスペリエンスも全てAPIを呼ぶ**
- 初期表示で20件表示されるが、ユーザーが全て見るとは限らない

#### 影響
- 不要なAPI呼び出しが発生
- 特にモバイル環境では、最初の数件しか見えないのに、全20件のAPIを呼ぶ

#### 解決策
- **Intersection Observer API**を使用して、ビューポートに入ったエクスペリエンスのみAPIを呼ぶ
- または、**初期表示件数を減らす**（例: 最初は10件のみ表示）

### 4. おすすめ機能での重複取得の可能性

#### 問題
- `fetchPlaces`関数で複数の`type`で並列検索しているが、**同じ場所が複数の`type`で返される可能性がある**
- その後、`fetchPlaceDetails`で各場所の詳細を取得するが、重複チェックが不十分な可能性がある

#### 影響
- 同じ`place_id`に対して複数回`Place Details API`を呼ぶ可能性

#### 現在の実装
```typescript
// 重複を除去しているが、詳細取得前にのみ
const uniquePlaces = Array.from(new Map(allPlaces.map((p) => [p.place_id, p])).values());
```

#### 解決策
- 詳細取得前に重複チェックを確実に行う（既に実装されているが、要確認）

### 5. チャット検索での順次実行による無駄

#### 問題
- `lib/functionRegistry.ts`の`searchWithTypes`関数は、forループで順次実行している
- 結果が見つかったら即座にreturnするため、実際には問題ないが、**理論上は複数のtypeで同じ場所を検索する可能性がある**

#### 影響
- 最小限（早期終了があるため）

---

## 最適化の優先順位

### 高優先度（即座に実装すべき）

1. **エクスペリエンス一覧でのバッチ取得**
   - 影響: 最大20回のAPI呼び出しを1回に削減可能
   - 実装難易度: 中

2. **GoogleMapsReviewsのキャッシュ追加**
   - 影響: 同じページでの重複呼び出しを防止
   - 実装難易度: 低

3. **ビューポート外の遅延読み込み**
   - 影響: 不要なAPI呼び出しを削減
   - 実装難易度: 中

### 中優先度（検討すべき）

4. **グローバルなリクエストキュー**
   - 影響: 同じplaceIdに対する重複リクエストを防止
   - 実装難易度: 中

5. **重複チェックの強化**
   - 影響: おすすめ機能での重複取得を完全に防止
   - 実装難易度: 低

### 低優先度（現状で問題ない）

6. **チャット検索の最適化**
   - 影響: 小（早期終了により既に最適化されている）

---

## 更新日
2024年12月（分析実施日）

